<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.11.1/styles/default.min.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.18.10/dist/browser/index.js"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.18.10/dist/index.js"></script><script>(r => {
              setTimeout(r);
            })(function renderToolbar() {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root2, jsonOptions) => {
              const markmap = getMarkmap();
              window.mm = markmap.Markmap.create(
                "svg#mindmap",
                (getOptions || markmap.deriveOptions)(jsonOptions),
                root2
              );
            })(() => window.markmap,null,{"content":"","children":[{"content":"&#x4e00;. &#x57fa;&#x7840;&#x5750;&#x6807;&#x7cfb;&#x7edf;&#x5e94;&#x7528;","children":[{"content":"1.1 &#x6e38;&#x620f;&#x5f15;&#x64ce;&#x4e2d;&#x7684;&#x5750;&#x6807;&#x7cfb;&#x7edf;","children":[{"content":"Unity3D&#xff08;&#x5de6;&#x624b;&#x5750;&#x6807;&#x7cfb;&#xff09;","children":[{"content":"<pre data-lines=\"4,23\"><code class=\"language-csharp\"><span class=\"hljs-comment\">// Unity&#x4e2d;&#x7684;&#x5750;&#x6807;&#x7cfb;&#x7edf;&#x793a;&#x4f8b;</span>\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">CoordinateSystemExample</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Example</span>()</span> \n    {\n        <span class=\"hljs-comment\">// &#x4e16;&#x754c;&#x5750;&#x6807;&#x7cfb;&#x4e2d;&#x7684;&#x4f4d;&#x7f6e;</span>\n        Vector3 worldPosition = transform.position;\n        \n        <span class=\"hljs-comment\">// &#x672c;&#x5730;&#x5750;&#x6807;&#x7cfb;&#x4e2d;&#x7684;&#x4f4d;&#x7f6e;</span>\n        Vector3 localPosition = transform.localPosition;\n        \n        <span class=\"hljs-comment\">// &#x65b9;&#x5411;&#x5411;&#x91cf;</span>\n        Vector3 forward = transform.forward;    <span class=\"hljs-comment\">// (0, 0, 1)</span>\n        Vector3 right = transform.right;        <span class=\"hljs-comment\">// (1, 0, 0)</span>\n        Vector3 up = transform.up;              <span class=\"hljs-comment\">// (0, 1, 0)</span>\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"4,23"}}],"payload":{"tag":"h4","lines":"3,4"}},{"content":"Unreal Engine&#xff08;&#x5de6;&#x624b;&#x5750;&#x6807;&#x7cfb;&#xff09;","children":[{"content":"<pre data-lines=\"25,41\"><code class=\"language-cpp\"><span class=\"hljs-comment\">// UE&#x4e2d;&#x7684;&#x5750;&#x6807;&#x7cfb;&#x7edf;&#x793a;&#x4f8b;</span>\n<span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">ACustomActor::CoordinateExample</span><span class=\"hljs-params\">()</span>\n</span>{\n    <span class=\"hljs-comment\">// &#x4e16;&#x754c;&#x5750;&#x6807;&#x7cfb;&#x4e2d;&#x7684;&#x4f4d;&#x7f6e;</span>\n    FVector WorldLocation = <span class=\"hljs-built_in\">GetActorLocation</span>();\n    \n    <span class=\"hljs-comment\">// &#x672c;&#x5730;&#x5750;&#x6807;&#x7cfb;&#x4e2d;&#x7684;&#x4f4d;&#x7f6e;</span>\n    FVector LocalLocation = <span class=\"hljs-built_in\">GetRootComponent</span>()-&gt;<span class=\"hljs-built_in\">GetRelativeLocation</span>();\n    \n    <span class=\"hljs-comment\">// &#x65b9;&#x5411;&#x5411;&#x91cf;</span>\n    FVector ForwardVector = <span class=\"hljs-built_in\">GetActorForwardVector</span>();\n    FVector RightVector = <span class=\"hljs-built_in\">GetActorRightVector</span>();\n    FVector UpVector = <span class=\"hljs-built_in\">GetActorUpVector</span>();\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"25,41"}}],"payload":{"tag":"h4","lines":"24,25"}}],"payload":{"tag":"h3","lines":"2,3"}}],"payload":{"tag":"h2","lines":"0,1"}},{"content":"&#x4e8c;. &#x5411;&#x91cf;&#x8fd0;&#x7b97;&#x5b9e;&#x6218;","children":[{"content":"2.1 &#x70b9;&#x79ef;&#x5e94;&#x7528;","children":[{"content":"&#x89c6;&#x91ce;&#x68c0;&#x6d4b;","children":[{"content":"<pre data-lines=\"46,66\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">VisionSystem</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> fieldOfView = <span class=\"hljs-number\">90f</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">IsInFieldOfView</span>(<span class=\"hljs-params\">Vector3 targetPosition</span>)</span> \n    {\n        Vector3 directionToTarget = (targetPosition - transform.position).normalized;\n        <span class=\"hljs-built_in\">float</span> angle = Vector3.Angle(transform.forward, directionToTarget);\n        <span class=\"hljs-keyword\">return</span> angle &lt;= fieldOfView * <span class=\"hljs-number\">0.5f</span>;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">GetVisibilityFactor</span>(<span class=\"hljs-params\">Vector3 targetPosition</span>)</span> \n    {\n        Vector3 directionToTarget = (targetPosition - transform.position).normalized;\n        <span class=\"hljs-built_in\">float</span> dot = Vector3.Dot(transform.forward, directionToTarget);\n        <span class=\"hljs-keyword\">return</span> Mathf.Max(<span class=\"hljs-number\">0</span>, dot); <span class=\"hljs-comment\">// 0&#x8868;&#x793a;&#x80cc;&#x5411;&#xff0c;1&#x8868;&#x793a;&#x6b63;&#x5411;</span>\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"46,66"}}],"payload":{"tag":"h4","lines":"45,46"}}],"payload":{"tag":"h3","lines":"44,45"}},{"content":"2.2 &#x53c9;&#x79ef;&#x5e94;&#x7528;","children":[{"content":"&#x5224;&#x65ad;&#x8f6c;&#x5411;&#x65b9;&#x5411;","children":[{"content":"<pre data-lines=\"69,83\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SteeringSystem</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">enum</span> TurnDirection { Left, Right, None }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> TurnDirection <span class=\"hljs-title\">GetTurnDirection</span>(<span class=\"hljs-params\">Vector3 forward, Vector3 targetDirection</span>)</span> \n    {\n        Vector3 cross = Vector3.Cross(forward, targetDirection);\n        <span class=\"hljs-keyword\">if</span> (cross.y &gt; <span class=\"hljs-number\">0.01f</span>) <span class=\"hljs-keyword\">return</span> TurnDirection.Left;\n        <span class=\"hljs-keyword\">if</span> (cross.y &lt; <span class=\"hljs-number\">-0.01f</span>) <span class=\"hljs-keyword\">return</span> TurnDirection.Right;\n        <span class=\"hljs-keyword\">return</span> TurnDirection.None;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"69,83"}}],"payload":{"tag":"h4","lines":"68,69"}}],"payload":{"tag":"h3","lines":"67,68"}}],"payload":{"tag":"h2","lines":"42,43"}},{"content":"&#x4e09;. &#x77e9;&#x9635;&#x53d8;&#x6362;&#x5e94;&#x7528;","children":[{"content":"3.1 &#x57fa;&#x7840;&#x53d8;&#x6362;&#x77e9;&#x9635;","children":[{"content":"<pre data-lines=\"87,127\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TransformationMatrix</span> \n{\n    <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x5e73;&#x79fb;&#x77e9;&#x9635;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Matrix4x4 <span class=\"hljs-title\">CreateTranslation</span>(<span class=\"hljs-params\">Vector3 translation</span>)</span> \n    {\n        Matrix4x4 matrix = Matrix4x4.identity;\n        matrix[<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">3</span>] = translation.x;\n        matrix[<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">3</span>] = translation.y;\n        matrix[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>] = translation.z;\n        <span class=\"hljs-keyword\">return</span> matrix;\n    }\n    \n    <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x7f29;&#x653e;&#x77e9;&#x9635;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Matrix4x4 <span class=\"hljs-title\">CreateScale</span>(<span class=\"hljs-params\">Vector3 scale</span>)</span> \n    {\n        Matrix4x4 matrix = Matrix4x4.identity;\n        matrix[<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>] = scale.x;\n        matrix[<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span>] = scale.y;\n        matrix[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">2</span>] = scale.z;\n        <span class=\"hljs-keyword\">return</span> matrix;\n    }\n    \n    <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x7ed5;X&#x8f74;&#x65cb;&#x8f6c;&#x77e9;&#x9635;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Matrix4x4 <span class=\"hljs-title\">CreateRotationX</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> angleInDegrees</span>)</span> \n    {\n        Matrix4x4 matrix = Matrix4x4.identity;\n        <span class=\"hljs-built_in\">float</span> rad = angleInDegrees * Mathf.Deg2Rad;\n        <span class=\"hljs-built_in\">float</span> cos = Mathf.Cos(rad);\n        <span class=\"hljs-built_in\">float</span> sin = Mathf.Sin(rad);\n        \n        matrix[<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span>] = cos;\n        matrix[<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>] = -sin;\n        matrix[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>] = sin;\n        matrix[<span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">2</span>] = cos;\n        \n        <span class=\"hljs-keyword\">return</span> matrix;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"87,127"}}],"payload":{"tag":"h3","lines":"86,87"}},{"content":"3.2 &#x590d;&#x5408;&#x53d8;&#x6362;&#x5e94;&#x7528;","children":[{"content":"<pre data-lines=\"129,155\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TransformationExample</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">ApplyComplexTransform</span>(<span class=\"hljs-params\">Vector3 position, Vector3 rotation, Vector3 scale</span>)</span> \n    {\n        <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x5404;&#x4e2a;&#x53d8;&#x6362;&#x77e9;&#x9635;</span>\n        Matrix4x4 translationMatrix = TransformationMatrix.CreateTranslation(position);\n        Matrix4x4 rotationX = TransformationMatrix.CreateRotationX(rotation.x);\n        Matrix4x4 rotationY = TransformationMatrix.CreateRotationX(rotation.y);\n        Matrix4x4 rotationZ = TransformationMatrix.CreateRotationX(rotation.z);\n        Matrix4x4 scaleMatrix = TransformationMatrix.CreateScale(scale);\n        \n        <span class=\"hljs-comment\">// &#x7ec4;&#x5408;&#x53d8;&#x6362;&#xff08;&#x6ce8;&#x610f;&#x987a;&#x5e8f;&#xff1a;&#x7f29;&#x653e;-&gt;&#x65cb;&#x8f6c;-&gt;&#x5e73;&#x79fb;&#xff09;</span>\n        Matrix4x4 finalTransform = translationMatrix * \n                                 rotationZ * \n                                 rotationY * \n                                 rotationX * \n                                 scaleMatrix;\n                                 \n        <span class=\"hljs-comment\">// &#x5e94;&#x7528;&#x53d8;&#x6362;&#x5230;&#x7269;&#x4f53;</span>\n        transform.position = finalTransform.MultiplyPoint3x4(Vector3.zero);\n        transform.rotation = Quaternion.Euler(rotation);\n        transform.localScale = scale;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"129,155"}}],"payload":{"tag":"h3","lines":"128,129"}}],"payload":{"tag":"h2","lines":"84,85"}},{"content":"&#x56db;. &#x6e38;&#x620f;&#x7269;&#x7406;&#x7cfb;&#x7edf;&#x5e94;&#x7528;","children":[{"content":"4.1 &#x57fa;&#x7840;&#x7269;&#x7406;&#x6a21;&#x62df;","children":[{"content":"<pre data-lines=\"159,193\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">PhysicsSimulation</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> Vector3 velocity;\n    <span class=\"hljs-keyword\">public</span> Vector3 acceleration;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> mass = <span class=\"hljs-number\">1f</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span> \n    {\n        <span class=\"hljs-comment\">// &#x57fa;&#x7840;&#x7269;&#x7406;&#x66f4;&#x65b0;</span>\n        velocity += acceleration * Time.deltaTime;\n        transform.position += velocity * Time.deltaTime;\n        \n        <span class=\"hljs-comment\">// &#x91cd;&#x529b;</span>\n        ApplyGravity();\n        \n        <span class=\"hljs-comment\">// &#x7a7a;&#x6c14;&#x963b;&#x529b;</span>\n        ApplyDrag();\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">ApplyGravity</span>()</span> \n    {\n        Vector3 gravity = <span class=\"hljs-keyword\">new</span> Vector3(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">-9.81f</span>, <span class=\"hljs-number\">0</span>);\n        velocity += gravity * Time.deltaTime;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">ApplyDrag</span>()</span> \n    {\n        <span class=\"hljs-built_in\">float</span> dragCoefficient = <span class=\"hljs-number\">0.1f</span>;\n        Vector3 drag = -velocity.normalized * velocity.sqrMagnitude * dragCoefficient;\n        velocity += drag * Time.deltaTime / mass;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"159,193"}}],"payload":{"tag":"h3","lines":"158,159"}},{"content":"4.2 &#x78b0;&#x649e;&#x68c0;&#x6d4b;","children":[{"content":"<pre data-lines=\"195,217\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">CollisionDetection</span> \n{\n    <span class=\"hljs-comment\">// &#x7403;&#x4f53;&#x78b0;&#x649e;&#x68c0;&#x6d4b;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">SphereCollision</span>(<span class=\"hljs-params\">Vector3 center1, <span class=\"hljs-built_in\">float</span> radius1, \n                                     Vector3 center2, <span class=\"hljs-built_in\">float</span> radius2</span>)</span> \n    {\n        <span class=\"hljs-built_in\">float</span> distanceSquared = (center2 - center1).sqrMagnitude;\n        <span class=\"hljs-built_in\">float</span> radiusSum = radius1 + radius2;\n        <span class=\"hljs-keyword\">return</span> distanceSquared &lt;= radiusSum * radiusSum;\n    }\n    \n    <span class=\"hljs-comment\">// AABB&#x78b0;&#x649e;&#x68c0;&#x6d4b;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">AABBCollision</span>(<span class=\"hljs-params\">Vector3 min1, Vector3 max1, \n                                   Vector3 min2, Vector3 max2</span>)</span> \n    {\n        <span class=\"hljs-keyword\">return</span> (min1.x &lt;= max2.x &amp;&amp; max1.x &gt;= min2.x) &amp;&amp;\n               (min1.y &lt;= max2.y &amp;&amp; max1.y &gt;= min2.y) &amp;&amp;\n               (min1.z &lt;= max2.z &amp;&amp; max1.z &gt;= min2.z);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"195,217"}}],"payload":{"tag":"h3","lines":"194,195"}}],"payload":{"tag":"h2","lines":"156,157"}},{"content":"&#x4e94;. &#x8ba1;&#x7b97;&#x673a;&#x56fe;&#x5f62;&#x5b66;&#x5e94;&#x7528;","children":[{"content":"5.1 &#x5149;&#x7167;&#x8ba1;&#x7b97;","children":[{"content":"<pre data-lines=\"221,239\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">LightingCalculator</span> \n{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">CalculateDiffuseLighting</span>(<span class=\"hljs-params\">Vector3 normal, Vector3 lightDir</span>)</span> \n    {\n        <span class=\"hljs-built_in\">float</span> NdotL = Mathf.Max(<span class=\"hljs-number\">0</span>, Vector3.Dot(normal, lightDir));\n        <span class=\"hljs-keyword\">return</span> NdotL;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Vector3 <span class=\"hljs-title\">CalculateSpecularLighting</span>(<span class=\"hljs-params\">Vector3 normal, Vector3 lightDir, \n                                                  Vector3 viewDir, <span class=\"hljs-built_in\">float</span> shininess</span>)</span> \n    {\n        Vector3 reflectDir = Vector3.Reflect(-lightDir, normal);\n        <span class=\"hljs-built_in\">float</span> spec = Mathf.Pow(Mathf.Max(<span class=\"hljs-number\">0</span>, Vector3.Dot(viewDir, reflectDir)), shininess);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Vector3(spec, spec, spec);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"221,239"}}],"payload":{"tag":"h3","lines":"220,221"}},{"content":"5.2 &#x76f8;&#x673a;&#x6295;&#x5f71;","children":[{"content":"<pre data-lines=\"241,260\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">CameraProjection</span> \n{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Matrix4x4 <span class=\"hljs-title\">CreatePerspectiveProjection</span>(<span class=\"hljs-params\">\n        <span class=\"hljs-built_in\">float</span> fov, <span class=\"hljs-built_in\">float</span> aspectRatio, <span class=\"hljs-built_in\">float</span> near, <span class=\"hljs-built_in\">float</span> far</span>)</span> \n    {\n        Matrix4x4 matrix = Matrix4x4.zero;\n        <span class=\"hljs-built_in\">float</span> tanHalfFov = Mathf.Tan(fov * <span class=\"hljs-number\">0.5f</span> * Mathf.Deg2Rad);\n        \n        matrix[<span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">0</span>] = <span class=\"hljs-number\">1f</span> / (aspectRatio * tanHalfFov);\n        matrix[<span class=\"hljs-number\">1</span>,<span class=\"hljs-number\">1</span>] = <span class=\"hljs-number\">1f</span> / tanHalfFov;\n        matrix[<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">2</span>] = -(far + near) / (far - near);\n        matrix[<span class=\"hljs-number\">2</span>,<span class=\"hljs-number\">3</span>] = -(<span class=\"hljs-number\">2f</span> * far * near) / (far - near);\n        matrix[<span class=\"hljs-number\">3</span>,<span class=\"hljs-number\">2</span>] = <span class=\"hljs-number\">-1f</span>;\n        \n        <span class=\"hljs-keyword\">return</span> matrix;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"241,260"}}],"payload":{"tag":"h3","lines":"240,241"}}],"payload":{"tag":"h2","lines":"218,219"}},{"content":"&#x516d;. &#x5de5;&#x7a0b;&#x5e94;&#x7528;","children":[{"content":"6.1 CAD&#x7cfb;&#x7edf;&#x57fa;&#x7840;&#x64cd;&#x4f5c;","children":[{"content":"<pre data-lines=\"264,287\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">CADSystem</span> \n{\n    <span class=\"hljs-comment\">// 2D&#x7ed8;&#x56fe;&#x529f;&#x80fd;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Vector2[] <span class=\"hljs-title\">CreateRectangle</span>(<span class=\"hljs-params\">Vector2 center, <span class=\"hljs-built_in\">float</span> width, <span class=\"hljs-built_in\">float</span> height</span>)</span> \n    {\n        Vector2[] points = <span class=\"hljs-keyword\">new</span> Vector2[<span class=\"hljs-number\">4</span>];\n        points[<span class=\"hljs-number\">0</span>] = center + <span class=\"hljs-keyword\">new</span> Vector2(-width/<span class=\"hljs-number\">2</span>, -height/<span class=\"hljs-number\">2</span>);\n        points[<span class=\"hljs-number\">1</span>] = center + <span class=\"hljs-keyword\">new</span> Vector2(width/<span class=\"hljs-number\">2</span>, -height/<span class=\"hljs-number\">2</span>);\n        points[<span class=\"hljs-number\">2</span>] = center + <span class=\"hljs-keyword\">new</span> Vector2(width/<span class=\"hljs-number\">2</span>, height/<span class=\"hljs-number\">2</span>);\n        points[<span class=\"hljs-number\">3</span>] = center + <span class=\"hljs-keyword\">new</span> Vector2(-width/<span class=\"hljs-number\">2</span>, height/<span class=\"hljs-number\">2</span>);\n        <span class=\"hljs-keyword\">return</span> points;\n    }\n    \n    <span class=\"hljs-comment\">// 3D&#x5efa;&#x6a21;&#x529f;&#x80fd;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Mesh <span class=\"hljs-title\">CreateCube</span>(<span class=\"hljs-params\">Vector3 center, Vector3 dimensions</span>)</span> \n    {\n        Mesh mesh = <span class=\"hljs-keyword\">new</span> Mesh();\n        <span class=\"hljs-comment\">// &#x5b9e;&#x73b0;&#x7701;&#x7565;...</span>\n        <span class=\"hljs-keyword\">return</span> mesh;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"264,287"}}],"payload":{"tag":"h3","lines":"263,264"}},{"content":"6.2 &#x673a;&#x5668;&#x4eba;&#x8fd0;&#x52a8;&#x63a7;&#x5236;","children":[{"content":"<pre data-lines=\"289,350\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">RobotController</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> Joint \n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 position;\n        <span class=\"hljs-keyword\">public</span> Vector3 rotation;\n        <span class=\"hljs-keyword\">public</span> Vector3 axis;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Vector3 <span class=\"hljs-title\">CalculateEndEffectorPosition</span>(<span class=\"hljs-params\">Joint[] joints</span>)</span> \n    {\n        Vector3 position = Vector3.zero;\n        Quaternion rotation = Quaternion.identity;\n        \n        <span class=\"hljs-keyword\">foreach</span> (Joint joint <span class=\"hljs-keyword\">in</span> joints) \n        {\n            rotation *= Quaternion.AngleAxis(\n                Vector3.Angle(Vector3.forward, joint.axis),\n                joint.rotation\n            );\n            position += rotation * joint.position;\n        }\n        \n        <span class=\"hljs-keyword\">return</span> position;\n    }\n} \n\n<span class=\"hljs-meta\">## &#x4e03;. &#x6781;&#x5750;&#x6807;&#x7cfb;&#x7edf;&#x5e94;&#x7528;</span>\n\n<span class=\"hljs-meta\">### 7.1 &#x57fa;&#x7840;&#x6781;&#x5750;&#x6807;&#x7cfb;&#x7edf;</span>\n```csharp\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> PolarCoordinate \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> radius;    <span class=\"hljs-comment\">// &#x6781;&#x5f84;&#xff08;&#x5230;&#x539f;&#x70b9;&#x8ddd;&#x79bb;&#xff09;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> angle;     <span class=\"hljs-comment\">// &#x6781;&#x89d2;&#xff08;&#x5f27;&#x5ea6;&#xff09;</span>\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">PolarCoordinate</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> r, <span class=\"hljs-built_in\">float</span> a</span>)</span> \n    {\n        radius = r;\n        angle = a;\n    }\n    \n    <span class=\"hljs-comment\">// &#x8f6c;&#x6362;&#x4e3a;&#x7b1b;&#x5361;&#x5c14;&#x5750;&#x6807;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Vector2 <span class=\"hljs-title\">ToCartesian</span>()</span> \n    {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Vector2(\n            radius * Mathf.Cos(angle),\n            radius * Mathf.Sin(angle)\n        );\n    }\n    \n    <span class=\"hljs-comment\">// &#x4ece;&#x7b1b;&#x5361;&#x5c14;&#x5750;&#x6807;&#x521b;&#x5efa;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> PolarCoordinate <span class=\"hljs-title\">FromCartesian</span>(<span class=\"hljs-params\">Vector2 cartesian</span>)</span> \n    {\n        <span class=\"hljs-built_in\">float</span> radius = Mathf.Sqrt(cartesian.x * cartesian.x + cartesian.y * cartesian.y);\n        <span class=\"hljs-built_in\">float</span> angle = Mathf.Atan2(cartesian.y, cartesian.x);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> PolarCoordinate(radius, angle);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"289,350"}}],"payload":{"tag":"h3","lines":"288,289"}},{"content":"7.2 &#x73af;&#x5f62;&#x8fd0;&#x52a8;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"352,388\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">CircularMotionController</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> radius = <span class=\"hljs-number\">5f</span>;           <span class=\"hljs-comment\">// &#x8fd0;&#x52a8;&#x534a;&#x5f84;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> angularSpeed = <span class=\"hljs-number\">2f</span>;     <span class=\"hljs-comment\">// &#x89d2;&#x901f;&#x5ea6;&#xff08;&#x5f27;&#x5ea6;/&#x79d2;&#xff09;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> phase = <span class=\"hljs-number\">0f</span>;            <span class=\"hljs-comment\">// &#x521d;&#x59cb;&#x76f8;&#x4f4d;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> clockwise = <span class=\"hljs-literal\">true</span>;       <span class=\"hljs-comment\">// &#x987a;&#x65f6;&#x9488;&#x65b9;&#x5411;</span>\n    \n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> currentAngle;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Start</span>()</span> \n    {\n        currentAngle = phase;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span> \n    {\n        <span class=\"hljs-comment\">// &#x66f4;&#x65b0;&#x89d2;&#x5ea6;</span>\n        <span class=\"hljs-built_in\">float</span> direction = clockwise ? <span class=\"hljs-number\">-1f</span> : <span class=\"hljs-number\">1f</span>;\n        currentAngle += direction * angularSpeed * Time.deltaTime;\n        \n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x65b0;&#x4f4d;&#x7f6e;</span>\n        Vector2 position = <span class=\"hljs-keyword\">new</span> Vector2(\n            radius * Mathf.Cos(currentAngle),\n            radius * Mathf.Sin(currentAngle)\n        );\n        \n        <span class=\"hljs-comment\">// &#x66f4;&#x65b0;&#x7269;&#x4f53;&#x4f4d;&#x7f6e;</span>\n        transform.position = <span class=\"hljs-keyword\">new</span> Vector3(position.x, position.y, <span class=\"hljs-number\">0</span>);\n        \n        <span class=\"hljs-comment\">// &#x53ef;&#x9009;&#xff1a;&#x4f7f;&#x7269;&#x4f53;&#x59cb;&#x7ec8;&#x671d;&#x5411;&#x8fd0;&#x52a8;&#x65b9;&#x5411;</span>\n        <span class=\"hljs-built_in\">float</span> rotationAngle = (currentAngle * Mathf.Rad2Deg) + (clockwise ? <span class=\"hljs-number\">90f</span> : <span class=\"hljs-number\">-90f</span>);\n        transform.rotation = Quaternion.Euler(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, rotationAngle);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"352,388"}}],"payload":{"tag":"h3","lines":"351,352"}},{"content":"7.3 &#x96f7;&#x8fbe;&#x626b;&#x63cf;&#x6548;&#x679c;","children":[{"content":"<pre data-lines=\"390,440\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">RadarSystem</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> scanRadius = <span class=\"hljs-number\">10f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> scanSpeed = <span class=\"hljs-number\">2f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> detectionAngle = <span class=\"hljs-number\">30f</span>;\n    <span class=\"hljs-keyword\">public</span> LayerMask targetLayer;\n    \n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> currentAngle;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span> \n    {\n        <span class=\"hljs-comment\">// &#x66f4;&#x65b0;&#x626b;&#x63cf;&#x89d2;&#x5ea6;</span>\n        currentAngle += scanSpeed * Time.deltaTime;\n        <span class=\"hljs-keyword\">if</span> (currentAngle &gt;= <span class=\"hljs-number\">360f</span>) currentAngle -= <span class=\"hljs-number\">360f</span>;\n        \n        <span class=\"hljs-comment\">// &#x6267;&#x884c;&#x626b;&#x63cf;</span>\n        Vector2 direction = <span class=\"hljs-keyword\">new</span> Vector2(\n            Mathf.Cos(currentAngle * Mathf.Deg2Rad),\n            Mathf.Sin(currentAngle * Mathf.Deg2Rad)\n        );\n        \n        RaycastHit2D[] hits = Physics2D.CircleCastAll(\n            transform.position,\n            scanRadius,\n            direction,\n            <span class=\"hljs-number\">0f</span>,\n            targetLayer\n        );\n        \n        <span class=\"hljs-keyword\">foreach</span> (RaycastHit2D hit <span class=\"hljs-keyword\">in</span> hits) \n        {\n            Vector2 toTarget = (hit.point - (Vector2)transform.position).normalized;\n            <span class=\"hljs-built_in\">float</span> angle = Vector2.Angle(direction, toTarget);\n            \n            <span class=\"hljs-keyword\">if</span> (angle &lt;= detectionAngle * <span class=\"hljs-number\">0.5f</span>) \n            {\n                <span class=\"hljs-comment\">// &#x76ee;&#x6807;&#x5728;&#x626b;&#x63cf;&#x8303;&#x56f4;&#x5185;</span>\n                OnTargetDetected(hit.collider.gameObject);\n            }\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">OnTargetDetected</span>(<span class=\"hljs-params\">GameObject target</span>)</span> \n    {\n        <span class=\"hljs-comment\">// &#x5904;&#x7406;&#x76ee;&#x6807;&#x68c0;&#x6d4b;&#x903b;&#x8f91;</span>\n        Debug.Log(<span class=\"hljs-string\">&#x24;&quot;Detected target: <span class=\"hljs-subst\">{target.name}</span>&quot;</span>);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"390,440"}}],"payload":{"tag":"h3","lines":"389,390"}}],"payload":{"tag":"h2","lines":"261,262"}},{"content":"&#x516b;. &#x7403;&#x5750;&#x6807;&#x7cfb;&#x7edf;&#x5e94;&#x7528;","children":[{"content":"8.1 &#x7403;&#x5750;&#x6807;&#x57fa;&#x7840;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"444,478\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> SphericalCoordinate \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> radius;    <span class=\"hljs-comment\">// &#x5230;&#x539f;&#x70b9;&#x7684;&#x8ddd;&#x79bb;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> theta;     <span class=\"hljs-comment\">// &#x65b9;&#x4f4d;&#x89d2;&#xff08;&#x6c34;&#x5e73;&#x9762;&#x5185;&#x7684;&#x89d2;&#x5ea6;&#xff09;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> phi;       <span class=\"hljs-comment\">// &#x4ef0;&#x89d2;&#xff08;&#x4e0e;&#x5782;&#x76f4;&#x8f74;&#x7684;&#x5939;&#x89d2;&#xff09;</span>\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">SphericalCoordinate</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> r, <span class=\"hljs-built_in\">float</span> t, <span class=\"hljs-built_in\">float</span> p</span>)</span> \n    {\n        radius = r;\n        theta = t;\n        phi = p;\n    }\n    \n    <span class=\"hljs-comment\">// &#x8f6c;&#x6362;&#x4e3a;&#x7b1b;&#x5361;&#x5c14;&#x5750;&#x6807;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Vector3 <span class=\"hljs-title\">ToCartesian</span>()</span> \n    {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Vector3(\n            radius * Mathf.Sin(phi) * Mathf.Cos(theta),\n            radius * Mathf.Cos(phi),\n            radius * Mathf.Sin(phi) * Mathf.Sin(theta)\n        );\n    }\n    \n    <span class=\"hljs-comment\">// &#x4ece;&#x7b1b;&#x5361;&#x5c14;&#x5750;&#x6807;&#x521b;&#x5efa;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> SphericalCoordinate <span class=\"hljs-title\">FromCartesian</span>(<span class=\"hljs-params\">Vector3 cartesian</span>)</span> \n    {\n        <span class=\"hljs-built_in\">float</span> radius = cartesian.magnitude;\n        <span class=\"hljs-built_in\">float</span> theta = Mathf.Atan2(cartesian.z, cartesian.x);\n        <span class=\"hljs-built_in\">float</span> phi = Mathf.Acos(cartesian.y / radius);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SphericalCoordinate(radius, theta, phi);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"444,478"}}],"payload":{"tag":"h3","lines":"443,444"}},{"content":"8.2 &#x9ad8;&#x7ea7;&#x8f68;&#x9053;&#x76f8;&#x673a;","children":[{"content":"<pre data-lines=\"480,573\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AdvancedOrbitCamera</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> Transform target;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> distance = <span class=\"hljs-number\">10f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> minDistance = <span class=\"hljs-number\">5f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> maxDistance = <span class=\"hljs-number\">20f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> horizontalSpeed = <span class=\"hljs-number\">1f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> verticalSpeed = <span class=\"hljs-number\">1f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> zoomSpeed = <span class=\"hljs-number\">1f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> smoothness = <span class=\"hljs-number\">5f</span>;\n    \n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> currentTheta = <span class=\"hljs-number\">0f</span>;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> currentPhi = Mathf.PI / <span class=\"hljs-number\">4f</span>;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> currentDistance;\n    <span class=\"hljs-keyword\">private</span> Vector3 currentPosition;\n    <span class=\"hljs-keyword\">private</span> Quaternion currentRotation;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Start</span>()</span> \n    {\n        currentDistance = distance;\n        UpdatePosition(<span class=\"hljs-literal\">true</span>);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span> \n    {\n        <span class=\"hljs-comment\">// &#x5904;&#x7406;&#x8f93;&#x5165;</span>\n        <span class=\"hljs-built_in\">float</span> mouseX = Input.GetAxis(<span class=\"hljs-string\">&quot;Mouse X&quot;</span>);\n        <span class=\"hljs-built_in\">float</span> mouseY = Input.GetAxis(<span class=\"hljs-string\">&quot;Mouse Y&quot;</span>);\n        <span class=\"hljs-built_in\">float</span> scroll = Input.GetAxis(<span class=\"hljs-string\">&quot;Mouse ScrollWheel&quot;</span>);\n        \n        <span class=\"hljs-keyword\">if</span> (Input.GetMouseButton(<span class=\"hljs-number\">1</span>)) <span class=\"hljs-comment\">// &#x53f3;&#x952e;&#x6309;&#x4e0b;&#x65f6;&#x65cb;&#x8f6c;</span>\n        {\n            currentTheta += mouseX * horizontalSpeed;\n            currentPhi = Mathf.Clamp(\n                currentPhi - mouseY * verticalSpeed,\n                <span class=\"hljs-number\">0.1f</span>,\n                Mathf.PI - <span class=\"hljs-number\">0.1f</span>\n            );\n        }\n        \n        <span class=\"hljs-comment\">// &#x5904;&#x7406;&#x7f29;&#x653e;</span>\n        currentDistance = Mathf.Clamp(\n            currentDistance - scroll * zoomSpeed,\n            minDistance,\n            maxDistance\n        );\n        \n        UpdatePosition(<span class=\"hljs-literal\">false</span>);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">UpdatePosition</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">bool</span> instant</span>)</span> \n    {\n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x76ee;&#x6807;&#x4f4d;&#x7f6e;</span>\n        Vector3 targetPosition = <span class=\"hljs-keyword\">new</span> Vector3(\n            currentDistance * Mathf.Sin(currentPhi) * Mathf.Cos(currentTheta),\n            currentDistance * Mathf.Cos(currentPhi),\n            currentDistance * Mathf.Sin(currentPhi) * Mathf.Sin(currentTheta)\n        );\n        targetPosition += target.position;\n        \n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x76ee;&#x6807;&#x65cb;&#x8f6c;</span>\n        Quaternion targetRotation = Quaternion.LookRotation(\n            target.position - targetPosition,\n            Vector3.up\n        );\n        \n        <span class=\"hljs-keyword\">if</span> (instant) \n        {\n            currentPosition = targetPosition;\n            currentRotation = targetRotation;\n        } \n        <span class=\"hljs-keyword\">else</span> \n        {\n            <span class=\"hljs-comment\">// &#x5e73;&#x6ed1;&#x63d2;&#x503c;</span>\n            currentPosition = Vector3.Lerp(\n                currentPosition,\n                targetPosition,\n                Time.deltaTime * smoothness\n            );\n            currentRotation = Quaternion.Slerp(\n                currentRotation,\n                targetRotation,\n                Time.deltaTime * smoothness\n            );\n        }\n        \n        <span class=\"hljs-comment\">// &#x5e94;&#x7528;&#x53d8;&#x6362;</span>\n        transform.position = currentPosition;\n        transform.rotation = currentRotation;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"480,573"}}],"payload":{"tag":"h3","lines":"479,480"}}],"payload":{"tag":"h2","lines":"441,442"}},{"content":"&#x4e5d;. &#x5706;&#x67f1;&#x5750;&#x6807;&#x7cfb;&#x7edf;&#x5e94;&#x7528;","children":[{"content":"9.1 &#x5706;&#x67f1;&#x5750;&#x6807;&#x57fa;&#x7840;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"577,610\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> CylindricalCoordinate \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> radius;    <span class=\"hljs-comment\">// &#x5230;&#x4e2d;&#x8f74;&#x7684;&#x8ddd;&#x79bb;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> theta;     <span class=\"hljs-comment\">// &#x65b9;&#x4f4d;&#x89d2;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> height;    <span class=\"hljs-comment\">// &#x9ad8;&#x5ea6;</span>\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">CylindricalCoordinate</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> r, <span class=\"hljs-built_in\">float</span> t, <span class=\"hljs-built_in\">float</span> h</span>)</span> \n    {\n        radius = r;\n        theta = t;\n        height = h;\n    }\n    \n    <span class=\"hljs-comment\">// &#x8f6c;&#x6362;&#x4e3a;&#x7b1b;&#x5361;&#x5c14;&#x5750;&#x6807;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Vector3 <span class=\"hljs-title\">ToCartesian</span>()</span> \n    {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Vector3(\n            radius * Mathf.Cos(theta),\n            height,\n            radius * Mathf.Sin(theta)\n        );\n    }\n    \n    <span class=\"hljs-comment\">// &#x4ece;&#x7b1b;&#x5361;&#x5c14;&#x5750;&#x6807;&#x521b;&#x5efa;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> CylindricalCoordinate <span class=\"hljs-title\">FromCartesian</span>(<span class=\"hljs-params\">Vector3 cartesian</span>)</span> \n    {\n        <span class=\"hljs-built_in\">float</span> radius = Mathf.Sqrt(cartesian.x * cartesian.x + cartesian.z * cartesian.z);\n        <span class=\"hljs-built_in\">float</span> theta = Mathf.Atan2(cartesian.z, cartesian.x);\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> CylindricalCoordinate(radius, theta, cartesian.y);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"577,610"}}],"payload":{"tag":"h3","lines":"576,577"}},{"content":"9.2 &#x87ba;&#x65cb;&#x697c;&#x68af;&#x751f;&#x6210;&#x5668;","children":[{"content":"<pre data-lines=\"612,648\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpiralStairGenerator</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> radius = <span class=\"hljs-number\">2f</span>;           <span class=\"hljs-comment\">// &#x87ba;&#x65cb;&#x534a;&#x5f84;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> heightPerStep = <span class=\"hljs-number\">0.3f</span>;  <span class=\"hljs-comment\">// &#x6bcf;&#x7ea7;&#x53f0;&#x9636;&#x9ad8;&#x5ea6;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> anglePerStep = <span class=\"hljs-number\">30f</span>;    <span class=\"hljs-comment\">// &#x6bcf;&#x7ea7;&#x53f0;&#x9636;&#x89d2;&#x5ea6;</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">int</span> totalSteps = <span class=\"hljs-number\">12</span>;         <span class=\"hljs-comment\">// &#x603b;&#x53f0;&#x9636;&#x6570;</span>\n    <span class=\"hljs-keyword\">public</span> GameObject stepPrefab;       <span class=\"hljs-comment\">// &#x53f0;&#x9636;&#x9884;&#x5236;&#x4f53;</span>\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Start</span>()</span> \n    {\n        GenerateStairs();\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">GenerateStairs</span>()</span> \n    {\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; totalSteps; i++) \n        {\n            <span class=\"hljs-built_in\">float</span> angle = i * anglePerStep * Mathf.Deg2Rad;\n            <span class=\"hljs-built_in\">float</span> height = i * heightPerStep;\n            \n            <span class=\"hljs-comment\">// &#x4f7f;&#x7528;&#x5706;&#x67f1;&#x5750;&#x6807;&#x8ba1;&#x7b97;&#x4f4d;&#x7f6e;</span>\n            CylindricalCoordinate coord = <span class=\"hljs-keyword\">new</span> CylindricalCoordinate(radius, angle, height);\n            Vector3 position = coord.ToCartesian();\n            \n            <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x53f0;&#x9636;</span>\n            GameObject step = Instantiate(stepPrefab, transform);\n            step.transform.position = position;\n            \n            <span class=\"hljs-comment\">// &#x8bbe;&#x7f6e;&#x65cb;&#x8f6c;&#xff08;&#x4f7f;&#x53f0;&#x9636;&#x671d;&#x5411;&#x4e2d;&#x5fc3;&#x8f74;&#xff09;</span>\n            <span class=\"hljs-built_in\">float</span> rotationAngle = angle * Mathf.Rad2Deg;\n            step.transform.rotation = Quaternion.Euler(<span class=\"hljs-number\">0</span>, rotationAngle, <span class=\"hljs-number\">0</span>);\n        }\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"612,648"}}],"payload":{"tag":"h3","lines":"611,612"}}],"payload":{"tag":"h2","lines":"574,575"}},{"content":"&#x5341;. 3D&#x65cb;&#x8f6c;&#x5e94;&#x7528;","children":[{"content":"10.1 &#x6b27;&#x62c9;&#x89d2;&#x65cb;&#x8f6c;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"652,685\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">EulerRotationController</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> Vector3 rotationSpeed = <span class=\"hljs-keyword\">new</span> Vector3(<span class=\"hljs-number\">30f</span>, <span class=\"hljs-number\">45f</span>, <span class=\"hljs-number\">60f</span>);\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> useLocalRotation = <span class=\"hljs-literal\">true</span>;\n    \n    <span class=\"hljs-keyword\">private</span> Vector3 currentRotation;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span> \n    {\n        <span class=\"hljs-comment\">// &#x66f4;&#x65b0;&#x6b27;&#x62c9;&#x89d2;</span>\n        currentRotation += rotationSpeed * Time.deltaTime;\n        \n        <span class=\"hljs-comment\">// &#x6807;&#x51c6;&#x5316;&#x89d2;&#x5ea6;&#x5230;0-360&#x8303;&#x56f4;</span>\n        currentRotation.x = NormalizeAngle(currentRotation.x);\n        currentRotation.y = NormalizeAngle(currentRotation.y);\n        currentRotation.z = NormalizeAngle(currentRotation.z);\n        \n        <span class=\"hljs-comment\">// &#x5e94;&#x7528;&#x65cb;&#x8f6c;</span>\n        <span class=\"hljs-keyword\">if</span> (useLocalRotation)\n            transform.localRotation = Quaternion.Euler(currentRotation);\n        <span class=\"hljs-keyword\">else</span>\n            transform.rotation = Quaternion.Euler(currentRotation);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">NormalizeAngle</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> angle</span>)</span> \n    {\n        <span class=\"hljs-keyword\">while</span> (angle &gt; <span class=\"hljs-number\">360f</span>) angle -= <span class=\"hljs-number\">360f</span>;\n        <span class=\"hljs-keyword\">while</span> (angle &lt; <span class=\"hljs-number\">0f</span>) angle += <span class=\"hljs-number\">360f</span>;\n        <span class=\"hljs-keyword\">return</span> angle;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"652,685"}}],"payload":{"tag":"h3","lines":"651,652"}},{"content":"10.2 &#x56db;&#x5143;&#x6570;&#x65cb;&#x8f6c;&#x63d2;&#x503c;","children":[{"content":"<pre data-lines=\"687,728\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">QuaternionRotationController</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> Transform targetA;\n    <span class=\"hljs-keyword\">public</span> Transform targetB;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> rotationDuration = <span class=\"hljs-number\">1f</span>;\n    <span class=\"hljs-keyword\">public</span> AnimationCurve rotationCurve = AnimationCurve.EaseInOut(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span>);\n    \n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> currentTime = <span class=\"hljs-number\">0f</span>;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">bool</span> isRotating = <span class=\"hljs-literal\">false</span>;\n    <span class=\"hljs-keyword\">private</span> Quaternion startRotation;\n    <span class=\"hljs-keyword\">private</span> Quaternion endRotation;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">StartRotation</span>()</span> \n    {\n        startRotation = transform.rotation;\n        endRotation = targetB.rotation;\n        currentTime = <span class=\"hljs-number\">0f</span>;\n        isRotating = <span class=\"hljs-literal\">true</span>;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span> \n    {\n        <span class=\"hljs-keyword\">if</span> (!isRotating) <span class=\"hljs-keyword\">return</span>;\n        \n        currentTime += Time.deltaTime;\n        <span class=\"hljs-built_in\">float</span> t = currentTime / rotationDuration;\n        \n        <span class=\"hljs-keyword\">if</span> (t &gt;= <span class=\"hljs-number\">1f</span>) \n        {\n            transform.rotation = endRotation;\n            isRotating = <span class=\"hljs-literal\">false</span>;\n            <span class=\"hljs-keyword\">return</span>;\n        }\n        \n        <span class=\"hljs-comment\">// &#x4f7f;&#x7528;&#x66f2;&#x7ebf;&#x8fdb;&#x884c;&#x63d2;&#x503c;</span>\n        <span class=\"hljs-built_in\">float</span> curveValue = rotationCurve.Evaluate(t);\n        transform.rotation = Quaternion.Slerp(startRotation, endRotation, curveValue);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"687,728"}}],"payload":{"tag":"h3","lines":"686,687"}}],"payload":{"tag":"h2","lines":"649,650"}},{"content":"&#x5341;&#x4e00;. &#x9ad8;&#x7ea7;&#x76f8;&#x673a;&#x7cfb;&#x7edf;","children":[{"content":"11.1 &#x81ea;&#x7531;&#x89c6;&#x89d2;&#x76f8;&#x673a;","children":[{"content":"<pre data-lines=\"732,802\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">FreeLookCamera</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> moveSpeed = <span class=\"hljs-number\">5f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> rotationSpeed = <span class=\"hljs-number\">3f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> smoothness = <span class=\"hljs-number\">10f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> invertY = <span class=\"hljs-literal\">false</span>;\n    \n    <span class=\"hljs-keyword\">private</span> Vector3 targetPosition;\n    <span class=\"hljs-keyword\">private</span> Quaternion targetRotation;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Start</span>()</span> \n    {\n        targetPosition = transform.position;\n        targetRotation = transform.rotation;\n        Cursor.lockState = CursorLockMode.Locked;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span> \n    {\n        <span class=\"hljs-comment\">// &#x5904;&#x7406;&#x79fb;&#x52a8;&#x8f93;&#x5165;</span>\n        Vector3 moveInput = <span class=\"hljs-keyword\">new</span> Vector3(\n            Input.GetAxis(<span class=\"hljs-string\">&quot;Horizontal&quot;</span>),\n            <span class=\"hljs-number\">0</span>,\n            Input.GetAxis(<span class=\"hljs-string\">&quot;Vertical&quot;</span>)\n        );\n        \n        <span class=\"hljs-keyword\">if</span> (Input.GetKey(KeyCode.Q)) moveInput.y -= <span class=\"hljs-number\">1</span>;\n        <span class=\"hljs-keyword\">if</span> (Input.GetKey(KeyCode.E)) moveInput.y += <span class=\"hljs-number\">1</span>;\n        \n        <span class=\"hljs-comment\">// &#x8f6c;&#x6362;&#x79fb;&#x52a8;&#x65b9;&#x5411;&#x5230;&#x76f8;&#x673a;&#x7a7a;&#x95f4;</span>\n        Vector3 moveDirection = transform.TransformDirection(moveInput);\n        targetPosition += moveDirection * moveSpeed * Time.deltaTime;\n        \n        <span class=\"hljs-comment\">// &#x5904;&#x7406;&#x65cb;&#x8f6c;&#x8f93;&#x5165;</span>\n        <span class=\"hljs-built_in\">float</span> mouseX = Input.GetAxis(<span class=\"hljs-string\">&quot;Mouse X&quot;</span>) * rotationSpeed;\n        <span class=\"hljs-built_in\">float</span> mouseY = Input.GetAxis(<span class=\"hljs-string\">&quot;Mouse Y&quot;</span>) * rotationSpeed * (invertY ? <span class=\"hljs-number\">1</span> : <span class=\"hljs-number\">-1</span>);\n        \n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x76ee;&#x6807;&#x65cb;&#x8f6c;</span>\n        Vector3 currentEuler = targetRotation.eulerAngles;\n        currentEuler.x = ClampAngle(currentEuler.x + mouseY, <span class=\"hljs-number\">-89f</span>, <span class=\"hljs-number\">89f</span>);\n        currentEuler.y += mouseX;\n        targetRotation = Quaternion.Euler(currentEuler);\n        \n        <span class=\"hljs-comment\">// &#x5e73;&#x6ed1;&#x5e94;&#x7528;&#x53d8;&#x6362;</span>\n        transform.position = Vector3.Lerp(\n            transform.position,\n            targetPosition,\n            Time.deltaTime * smoothness\n        );\n        transform.rotation = Quaternion.Slerp(\n            transform.rotation,\n            targetRotation,\n            Time.deltaTime * smoothness\n        );\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">ClampAngle</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> angle, <span class=\"hljs-built_in\">float</span> min, <span class=\"hljs-built_in\">float</span> max</span>)</span> \n    {\n        <span class=\"hljs-keyword\">if</span> (angle &lt; <span class=\"hljs-number\">-360</span>) angle += <span class=\"hljs-number\">360</span>;\n        <span class=\"hljs-keyword\">if</span> (angle &gt; <span class=\"hljs-number\">360</span>) angle -= <span class=\"hljs-number\">360</span>;\n        <span class=\"hljs-keyword\">return</span> Mathf.Clamp(angle, min, max);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">OnDisable</span>()</span> \n    {\n        Cursor.lockState = CursorLockMode.None;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"732,802"}}],"payload":{"tag":"h3","lines":"731,732"}}],"payload":{"tag":"h2","lines":"729,730"}},{"content":"&#x5341;&#x4e8c;. &#x7c92;&#x5b50;&#x7cfb;&#x7edf;&#x5e94;&#x7528;","children":[{"content":"12.1 &#x87ba;&#x65cb;&#x7c92;&#x5b50;&#x53d1;&#x5c04;&#x5668;","children":[{"content":"<pre data-lines=\"806,917\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpiralParticleEmitter</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">int</span> particlesPerSpiral = <span class=\"hljs-number\">50</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> spiralRadius = <span class=\"hljs-number\">3f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> spiralHeight = <span class=\"hljs-number\">5f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> rotationsPerSpiral = <span class=\"hljs-number\">2f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> particleLifetime = <span class=\"hljs-number\">2f</span>;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> emissionRate = <span class=\"hljs-number\">0.1f</span>;\n    <span class=\"hljs-keyword\">public</span> Color startColor = Color.white;\n    <span class=\"hljs-keyword\">public</span> Color endColor = Color.clear;\n    \n    <span class=\"hljs-keyword\">private</span> ParticleSystem particleSystem;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> emissionTimer;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Start</span>()</span> \n    {\n        InitializeParticleSystem();\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">InitializeParticleSystem</span>()</span> \n    {\n        particleSystem = gameObject.AddComponent&lt;ParticleSystem&gt;();\n        <span class=\"hljs-keyword\">var</span> main = particleSystem.main;\n        main.startLifetime = particleLifetime;\n        main.startSize = <span class=\"hljs-number\">0.1f</span>;\n        main.startColor = startColor;\n        main.simulationSpace = ParticleSystemSimulationSpace.World;\n        \n        <span class=\"hljs-keyword\">var</span> emission = particleSystem.emission;\n        emission.enabled = <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// &#x6211;&#x4eec;&#x5c06;&#x624b;&#x52a8;&#x53d1;&#x5c04;&#x7c92;&#x5b50;</span>\n        \n        <span class=\"hljs-keyword\">var</span> colorOverLifetime = particleSystem.colorOverLifetime;\n        colorOverLifetime.enabled = <span class=\"hljs-literal\">true</span>;\n        \n        Gradient gradient = <span class=\"hljs-keyword\">new</span> Gradient();\n        gradient.SetKeys(\n            <span class=\"hljs-keyword\">new</span> GradientColorKey[] { \n                <span class=\"hljs-keyword\">new</span> GradientColorKey(startColor, <span class=\"hljs-number\">0.0f</span>),\n                <span class=\"hljs-keyword\">new</span> GradientColorKey(endColor, <span class=\"hljs-number\">1.0f</span>)\n            },\n            <span class=\"hljs-keyword\">new</span> GradientAlphaKey[] {\n                <span class=\"hljs-keyword\">new</span> GradientAlphaKey(<span class=\"hljs-number\">1.0f</span>, <span class=\"hljs-number\">0.0f</span>),\n                <span class=\"hljs-keyword\">new</span> GradientAlphaKey(<span class=\"hljs-number\">0.0f</span>, <span class=\"hljs-number\">1.0f</span>)\n            }\n        );\n        colorOverLifetime.color = gradient;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span> \n    {\n        emissionTimer += Time.deltaTime;\n        <span class=\"hljs-keyword\">if</span> (emissionTimer &gt;= emissionRate) \n        {\n            EmitSpiralParticles();\n            emissionTimer = <span class=\"hljs-number\">0f</span>;\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">EmitSpiralParticles</span>()</span> \n    {\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; particlesPerSpiral; i++) \n        {\n            <span class=\"hljs-built_in\">float</span> t = (<span class=\"hljs-built_in\">float</span>)i / particlesPerSpiral;\n            <span class=\"hljs-built_in\">float</span> angle = t * rotationsPerSpiral * <span class=\"hljs-number\">2f</span> * Mathf.PI;\n            <span class=\"hljs-built_in\">float</span> height = t * spiralHeight;\n            \n            <span class=\"hljs-comment\">// &#x4f7f;&#x7528;&#x5706;&#x67f1;&#x5750;&#x6807;&#x8ba1;&#x7b97;&#x4f4d;&#x7f6e;</span>\n            CylindricalCoordinate coord = <span class=\"hljs-keyword\">new</span> CylindricalCoordinate(\n                spiralRadius,\n                angle,\n                height\n            );\n            \n            Vector3 position = coord.ToCartesian() + transform.position;\n            \n            <span class=\"hljs-comment\">// &#x53d1;&#x5c04;&#x7c92;&#x5b50;</span>\n            <span class=\"hljs-keyword\">var</span> particle = <span class=\"hljs-keyword\">new</span> ParticleSystem.EmitParams();\n            particle.position = position;\n            particle.startColor = startColor;\n            particleSystem.Emit(particle, <span class=\"hljs-number\">1</span>);\n        }\n    }\n} \n\n<span class=\"hljs-meta\">## &#x5341;&#x4e09;. &#x57fa;&#x7840;&#x51e0;&#x4f55;&#x56fe;&#x5143;</span>\n\n<span class=\"hljs-meta\">### 13.1 3D&#x70b9;&#x548c;&#x5411;&#x91cf;&#x64cd;&#x4f5c;</span>\n```csharp\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> Point3D \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> x, y, z;\n    \n    <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x4e24;&#x70b9;&#x4e4b;&#x95f4;&#x7684;&#x8ddd;&#x79bb;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">DistanceTo</span>(<span class=\"hljs-params\">Point3D other</span>)</span> \n    {\n        <span class=\"hljs-built_in\">float</span> dx = other.x - x;\n        <span class=\"hljs-built_in\">float</span> dy = other.y - y;\n        <span class=\"hljs-built_in\">float</span> dz = other.z - z;\n        <span class=\"hljs-keyword\">return</span> Mathf.Sqrt(dx * dx + dy * dy + dz * dz);\n    }\n    \n    <span class=\"hljs-comment\">// &#x5224;&#x65ad;&#x70b9;&#x662f;&#x5426;&#x5728;&#x5305;&#x56f4;&#x76d2;&#x5185;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">IsInBoundingBox</span>(<span class=\"hljs-params\">Point3D min, Point3D max</span>)</span> \n    {\n        <span class=\"hljs-keyword\">return</span> x &gt;= min.x &amp;&amp; x &lt;= max.x &amp;&amp;\n               y &gt;= min.y &amp;&amp; y &lt;= max.y &amp;&amp;\n               z &gt;= min.z &amp;&amp; z &lt;= max.z;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"806,917"}}],"payload":{"tag":"h3","lines":"805,806"}},{"content":"13.2 &#x5c04;&#x7ebf;&#x548c;&#x76f4;&#x7ebf;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"919,948\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">RaycastSystem</span> : <span class=\"hljs-title\">MonoBehaviour</span> \n{\n    <span class=\"hljs-keyword\">public</span> LayerMask collisionLayer;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> maxDistance = <span class=\"hljs-number\">100f</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">CastRay</span>(<span class=\"hljs-params\">Vector3 origin, Vector3 direction, <span class=\"hljs-keyword\">out</span> RaycastHit hit</span>)</span> \n    {\n        Ray ray = <span class=\"hljs-keyword\">new</span> Ray(origin, direction);\n        <span class=\"hljs-keyword\">return</span> Physics.Raycast(ray, <span class=\"hljs-keyword\">out</span> hit, maxDistance, collisionLayer);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">SphereCast</span>(<span class=\"hljs-params\">Vector3 origin, <span class=\"hljs-built_in\">float</span> radius, Vector3 direction, <span class=\"hljs-keyword\">out</span> RaycastHit hit</span>)</span> \n    {\n        <span class=\"hljs-keyword\">return</span> Physics.SphereCast(\n            origin, radius, direction, <span class=\"hljs-keyword\">out</span> hit, maxDistance, collisionLayer\n        );\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> RaycastHit[] <span class=\"hljs-title\">ConeDetection</span>(<span class=\"hljs-params\">Vector3 origin, Vector3 direction, <span class=\"hljs-built_in\">float</span> angle</span>)</span> \n    {\n        <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x9525;&#x5f62;&#x68c0;&#x6d4b;&#x533a;&#x57df;</span>\n        <span class=\"hljs-built_in\">float</span> radius = Mathf.Tan(angle * Mathf.Deg2Rad) * maxDistance;\n        <span class=\"hljs-keyword\">return</span> Physics.SphereCastAll(\n            origin, radius, direction, maxDistance, collisionLayer\n        );\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"919,948"}}],"payload":{"tag":"h3","lines":"918,919"}}],"payload":{"tag":"h2","lines":"803,804"}},{"content":"&#x5341;&#x56db;. &#x78b0;&#x649e;&#x68c0;&#x6d4b;&#x7cfb;&#x7edf;","children":[{"content":"14.1 AABB&#x78b0;&#x649e;&#x68c0;&#x6d4b;","children":[{"content":"<pre data-lines=\"952,990\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AABBCollisionSystem</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> AABB \n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 min;\n        <span class=\"hljs-keyword\">public</span> Vector3 max;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">AABB</span>(<span class=\"hljs-params\">Vector3 min, Vector3 max</span>)</span> \n        {\n            <span class=\"hljs-keyword\">this</span>.min = min;\n            <span class=\"hljs-keyword\">this</span>.max = max;\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">Intersects</span>(<span class=\"hljs-params\">AABB other</span>)</span> \n        {\n            <span class=\"hljs-keyword\">return</span> (min.x &lt;= other.max.x &amp;&amp; max.x &gt;= other.min.x) &amp;&amp;\n                   (min.y &lt;= other.max.y &amp;&amp; max.y &gt;= other.min.y) &amp;&amp;\n                   (min.z &lt;= other.max.z &amp;&amp; max.z &gt;= other.min.z);\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">Contains</span>(<span class=\"hljs-params\">Vector3 point</span>)</span> \n        {\n            <span class=\"hljs-keyword\">return</span> point.x &gt;= min.x &amp;&amp; point.x &lt;= max.x &amp;&amp;\n                   point.y &gt;= min.y &amp;&amp; point.y &lt;= max.y &amp;&amp;\n                   point.z &gt;= min.z &amp;&amp; point.z &lt;= max.z;\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> AABB <span class=\"hljs-title\">Merge</span>(<span class=\"hljs-params\">AABB other</span>)</span> \n        {\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> AABB(\n                Vector3.Min(min, other.min),\n                Vector3.Max(max, other.max)\n            );\n        }\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"952,990"}}],"payload":{"tag":"h3","lines":"951,952"}},{"content":"14.2 OBB&#x78b0;&#x649e;&#x68c0;&#x6d4b;","children":[{"content":"<pre data-lines=\"992,1030\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OBBCollisionSystem</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> OBB \n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 center;\n        <span class=\"hljs-keyword\">public</span> Vector3 extents;\n        <span class=\"hljs-keyword\">public</span> Quaternion orientation;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Vector3[] <span class=\"hljs-title\">GetCorners</span>()</span> \n        {\n            Vector3[] corners = <span class=\"hljs-keyword\">new</span> Vector3[<span class=\"hljs-number\">8</span>];\n            Vector3[] axes = <span class=\"hljs-keyword\">new</span> Vector3[<span class=\"hljs-number\">3</span>] {\n                orientation * Vector3.right,\n                orientation * Vector3.up,\n                orientation * Vector3.forward\n            };\n            \n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">8</span>; i++) \n            {\n                corners[i] = center;\n                corners[i] += axes[<span class=\"hljs-number\">0</span>] * extents.x * ((i &amp; <span class=\"hljs-number\">1</span>) != <span class=\"hljs-number\">0</span> ? <span class=\"hljs-number\">1</span> : <span class=\"hljs-number\">-1</span>);\n                corners[i] += axes[<span class=\"hljs-number\">1</span>] * extents.y * ((i &amp; <span class=\"hljs-number\">2</span>) != <span class=\"hljs-number\">0</span> ? <span class=\"hljs-number\">1</span> : <span class=\"hljs-number\">-1</span>);\n                corners[i] += axes[<span class=\"hljs-number\">2</span>] * extents.z * ((i &amp; <span class=\"hljs-number\">4</span>) != <span class=\"hljs-number\">0</span> ? <span class=\"hljs-number\">1</span> : <span class=\"hljs-number\">-1</span>);\n            }\n            \n            <span class=\"hljs-keyword\">return</span> corners;\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">Intersects</span>(<span class=\"hljs-params\">OBB other</span>)</span> \n        {\n            <span class=\"hljs-comment\">// &#x4f7f;&#x7528;&#x5206;&#x79bb;&#x8f74;&#x5b9a;&#x7406;&#x68c0;&#x6d4b;&#x78b0;&#x649e;</span>\n            <span class=\"hljs-comment\">// &#x5b9e;&#x73b0;&#x7701;&#x7565;...</span>\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span>;\n        }\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"992,1030"}}],"payload":{"tag":"h3","lines":"991,992"}}],"payload":{"tag":"h2","lines":"949,950"}},{"content":"&#x5341;&#x4e94;. 3D&#x5efa;&#x6a21;&#x5de5;&#x5177;","children":[{"content":"15.1 &#x7a0b;&#x5e8f;&#x5316;&#x7f51;&#x683c;&#x751f;&#x6210;","children":[{"content":"<pre data-lines=\"1034,1083\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ProceduralMeshGenerator</span> \n{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Mesh <span class=\"hljs-title\">CreateCube</span>(<span class=\"hljs-params\">Vector3 size</span>)</span> \n    {\n        Mesh mesh = <span class=\"hljs-keyword\">new</span> Mesh();\n        \n        <span class=\"hljs-comment\">// &#x9876;&#x70b9;</span>\n        Vector3[] vertices = <span class=\"hljs-keyword\">new</span> Vector3[<span class=\"hljs-number\">8</span>];\n        vertices[<span class=\"hljs-number\">0</span>] = <span class=\"hljs-keyword\">new</span> Vector3(-size.x, -size.y, -size.z);\n        vertices[<span class=\"hljs-number\">1</span>] = <span class=\"hljs-keyword\">new</span> Vector3(size.x, -size.y, -size.z);\n        vertices[<span class=\"hljs-number\">2</span>] = <span class=\"hljs-keyword\">new</span> Vector3(size.x, size.y, -size.z);\n        vertices[<span class=\"hljs-number\">3</span>] = <span class=\"hljs-keyword\">new</span> Vector3(-size.x, size.y, -size.z);\n        vertices[<span class=\"hljs-number\">4</span>] = <span class=\"hljs-keyword\">new</span> Vector3(-size.x, -size.y, size.z);\n        vertices[<span class=\"hljs-number\">5</span>] = <span class=\"hljs-keyword\">new</span> Vector3(size.x, -size.y, size.z);\n        vertices[<span class=\"hljs-number\">6</span>] = <span class=\"hljs-keyword\">new</span> Vector3(size.x, size.y, size.z);\n        vertices[<span class=\"hljs-number\">7</span>] = <span class=\"hljs-keyword\">new</span> Vector3(-size.x, size.y, size.z);\n        \n        <span class=\"hljs-comment\">// &#x4e09;&#x89d2;&#x5f62;</span>\n        <span class=\"hljs-built_in\">int</span>[] triangles = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">int</span>[] {\n            <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-comment\">// &#x524d;&#x9762;</span>\n            <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">6</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">6</span>, <span class=\"hljs-number\">5</span>, <span class=\"hljs-comment\">// &#x53f3;&#x9762;</span>\n            <span class=\"hljs-number\">5</span>, <span class=\"hljs-number\">6</span>, <span class=\"hljs-number\">7</span>, <span class=\"hljs-number\">5</span>, <span class=\"hljs-number\">7</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-comment\">// &#x540e;&#x9762;</span>\n            <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">7</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-comment\">// &#x5de6;&#x9762;</span>\n            <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">7</span>, <span class=\"hljs-number\">6</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">6</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-comment\">// &#x4e0a;&#x9762;</span>\n            <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">5</span>  <span class=\"hljs-comment\">// &#x4e0b;&#x9762;</span>\n        };\n        \n        <span class=\"hljs-comment\">// UV&#x5750;&#x6807;</span>\n        Vector2[] uvs = <span class=\"hljs-keyword\">new</span> Vector2[<span class=\"hljs-number\">8</span>];\n        uvs[<span class=\"hljs-number\">0</span>] = <span class=\"hljs-keyword\">new</span> Vector2(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>);\n        uvs[<span class=\"hljs-number\">1</span>] = <span class=\"hljs-keyword\">new</span> Vector2(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>);\n        uvs[<span class=\"hljs-number\">2</span>] = <span class=\"hljs-keyword\">new</span> Vector2(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span>);\n        uvs[<span class=\"hljs-number\">3</span>] = <span class=\"hljs-keyword\">new</span> Vector2(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>);\n        uvs[<span class=\"hljs-number\">4</span>] = <span class=\"hljs-keyword\">new</span> Vector2(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>);\n        uvs[<span class=\"hljs-number\">5</span>] = <span class=\"hljs-keyword\">new</span> Vector2(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">0</span>);\n        uvs[<span class=\"hljs-number\">6</span>] = <span class=\"hljs-keyword\">new</span> Vector2(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span>);\n        uvs[<span class=\"hljs-number\">7</span>] = <span class=\"hljs-keyword\">new</span> Vector2(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>);\n        \n        mesh.vertices = vertices;\n        mesh.triangles = triangles;\n        mesh.uv = uvs;\n        mesh.RecalculateNormals();\n        mesh.RecalculateBounds();\n        \n        <span class=\"hljs-keyword\">return</span> mesh;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1034,1083"}}],"payload":{"tag":"h3","lines":"1033,1034"}},{"content":"15.2 &#x66f2;&#x9762;&#x751f;&#x6210;&#x5668;","children":[{"content":"<pre data-lines=\"1085,1147\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SurfaceGenerator</span> \n{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Mesh <span class=\"hljs-title\">CreateSphere</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> radius, <span class=\"hljs-built_in\">int</span> segments</span>)</span> \n    {\n        Mesh mesh = <span class=\"hljs-keyword\">new</span> Mesh();\n        \n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x9876;&#x70b9;&#x6570;&#x91cf;</span>\n        <span class=\"hljs-built_in\">int</span> verticalSegments = segments;\n        <span class=\"hljs-built_in\">int</span> horizontalSegments = segments * <span class=\"hljs-number\">2</span>;\n        <span class=\"hljs-built_in\">int</span> vertexCount = (verticalSegments + <span class=\"hljs-number\">1</span>) * (horizontalSegments + <span class=\"hljs-number\">1</span>);\n        \n        <span class=\"hljs-comment\">// &#x751f;&#x6210;&#x9876;&#x70b9;</span>\n        Vector3[] vertices = <span class=\"hljs-keyword\">new</span> Vector3[vertexCount];\n        Vector2[] uvs = <span class=\"hljs-keyword\">new</span> Vector2[vertexCount];\n        <span class=\"hljs-built_in\">int</span> index = <span class=\"hljs-number\">0</span>;\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">0</span>; y &lt;= verticalSegments; y++) \n        {\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">0</span>; x &lt;= horizontalSegments; x++) \n            {\n                <span class=\"hljs-built_in\">float</span> xSegment = (<span class=\"hljs-built_in\">float</span>)x / horizontalSegments;\n                <span class=\"hljs-built_in\">float</span> ySegment = (<span class=\"hljs-built_in\">float</span>)y / verticalSegments;\n                <span class=\"hljs-built_in\">float</span> xPos = Mathf.Cos(xSegment * Mathf.PI * <span class=\"hljs-number\">2</span>) * \n                           Mathf.Sin(ySegment * Mathf.PI);\n                <span class=\"hljs-built_in\">float</span> yPos = Mathf.Cos(ySegment * Mathf.PI);\n                <span class=\"hljs-built_in\">float</span> zPos = Mathf.Sin(xSegment * Mathf.PI * <span class=\"hljs-number\">2</span>) * \n                           Mathf.Sin(ySegment * Mathf.PI);\n                \n                vertices[index] = <span class=\"hljs-keyword\">new</span> Vector3(xPos, yPos, zPos) * radius;\n                uvs[index] = <span class=\"hljs-keyword\">new</span> Vector2(xSegment, ySegment);\n                index++;\n            }\n        }\n        \n        <span class=\"hljs-comment\">// &#x751f;&#x6210;&#x4e09;&#x89d2;&#x5f62;</span>\n        <span class=\"hljs-built_in\">int</span>[] triangles = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">int</span>[verticalSegments * horizontalSegments * <span class=\"hljs-number\">6</span>];\n        <span class=\"hljs-built_in\">int</span> triIndex = <span class=\"hljs-number\">0</span>;\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">0</span>; y &lt; verticalSegments; y++) \n        {\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">0</span>; x &lt; horizontalSegments; x++) \n            {\n                triangles[triIndex] = (y * (horizontalSegments + <span class=\"hljs-number\">1</span>)) + x;\n                triangles[triIndex + <span class=\"hljs-number\">1</span>] = ((y + <span class=\"hljs-number\">1</span>) * (horizontalSegments + <span class=\"hljs-number\">1</span>)) + x;\n                triangles[triIndex + <span class=\"hljs-number\">2</span>] = (y * (horizontalSegments + <span class=\"hljs-number\">1</span>)) + x + <span class=\"hljs-number\">1</span>;\n                triangles[triIndex + <span class=\"hljs-number\">3</span>] = ((y + <span class=\"hljs-number\">1</span>) * (horizontalSegments + <span class=\"hljs-number\">1</span>)) + x;\n                triangles[triIndex + <span class=\"hljs-number\">4</span>] = ((y + <span class=\"hljs-number\">1</span>) * (horizontalSegments + <span class=\"hljs-number\">1</span>)) + x + <span class=\"hljs-number\">1</span>;\n                triangles[triIndex + <span class=\"hljs-number\">5</span>] = (y * (horizontalSegments + <span class=\"hljs-number\">1</span>)) + x + <span class=\"hljs-number\">1</span>;\n                triIndex += <span class=\"hljs-number\">6</span>;\n            }\n        }\n        \n        mesh.vertices = vertices;\n        mesh.triangles = triangles;\n        mesh.uv = uvs;\n        mesh.RecalculateNormals();\n        \n        <span class=\"hljs-keyword\">return</span> mesh;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1085,1147"}}],"payload":{"tag":"h3","lines":"1084,1085"}}],"payload":{"tag":"h2","lines":"1031,1032"}},{"content":"&#x5341;&#x516d;. &#x51e0;&#x4f55;&#x5904;&#x7406;&#x7b97;&#x6cd5;","children":[{"content":"16.1 &#x4e09;&#x89d2;&#x5f62;&#x5904;&#x7406;","children":[{"content":"<pre data-lines=\"1151,1184\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TriangleProcessor</span> \n{\n    <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x4e09;&#x89d2;&#x5f62;&#x9762;&#x79ef;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">CalculateArea</span>(<span class=\"hljs-params\">Vector3 v1, Vector3 v2, Vector3 v3</span>)</span> \n    {\n        Vector3 cross = Vector3.Cross(v2 - v1, v3 - v1);\n        <span class=\"hljs-keyword\">return</span> cross.magnitude * <span class=\"hljs-number\">0.5f</span>;\n    }\n    \n    <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x91cd;&#x5fc3;&#x5750;&#x6807;</span>\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Vector3 <span class=\"hljs-title\">CalculateBarycentricCoordinates</span>(<span class=\"hljs-params\">\n        Vector3 point, Vector3 v1, Vector3 v2, Vector3 v3</span>)</span> \n    {\n        Vector3 v0 = v2 - v1;\n        Vector3 v1v = v3 - v1;\n        Vector3 v2v = point - v1;\n        \n        <span class=\"hljs-built_in\">float</span> d00 = Vector3.Dot(v0, v0);\n        <span class=\"hljs-built_in\">float</span> d01 = Vector3.Dot(v0, v1v);\n        <span class=\"hljs-built_in\">float</span> d11 = Vector3.Dot(v1v, v1v);\n        <span class=\"hljs-built_in\">float</span> d20 = Vector3.Dot(v2v, v0);\n        <span class=\"hljs-built_in\">float</span> d21 = Vector3.Dot(v2v, v1v);\n        \n        <span class=\"hljs-built_in\">float</span> denom = d00 * d11 - d01 * d01;\n        <span class=\"hljs-built_in\">float</span> v = (d11 * d20 - d01 * d21) / denom;\n        <span class=\"hljs-built_in\">float</span> w = (d00 * d21 - d01 * d20) / denom;\n        <span class=\"hljs-built_in\">float</span> u = <span class=\"hljs-number\">1.0f</span> - v - w;\n        \n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Vector3(u, v, w);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1151,1184"}}],"payload":{"tag":"h3","lines":"1150,1151"}},{"content":"16.2 &#x7f51;&#x683c;&#x7b80;&#x5316;","children":[{"content":"<pre data-lines=\"1186,1213\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">MeshSimplification</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> Edge \n    {\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">int</span> v1, v2;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> cost;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">Edge</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">int</span> v1, <span class=\"hljs-built_in\">int</span> v2, <span class=\"hljs-built_in\">float</span> cost</span>)</span> \n        {\n            <span class=\"hljs-keyword\">this</span>.v1 = v1;\n            <span class=\"hljs-keyword\">this</span>.v2 = v2;\n            <span class=\"hljs-keyword\">this</span>.cost = cost;\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> Mesh <span class=\"hljs-title\">SimplifyMesh</span>(<span class=\"hljs-params\">Mesh mesh, <span class=\"hljs-built_in\">float</span> quality</span>)</span> \n    {\n        <span class=\"hljs-comment\">// &#x5b9e;&#x73b0;&#x7701;&#x7565;...</span>\n        <span class=\"hljs-comment\">// 1. &#x8ba1;&#x7b97;&#x6bcf;&#x6761;&#x8fb9;&#x7684;&#x4ee3;&#x4ef7;</span>\n        <span class=\"hljs-comment\">// 2. &#x6309;&#x4ee3;&#x4ef7;&#x6392;&#x5e8f;</span>\n        <span class=\"hljs-comment\">// 3. &#x5408;&#x5e76;&#x9876;&#x70b9;</span>\n        <span class=\"hljs-comment\">// 4. &#x66f4;&#x65b0;&#x62d3;&#x6251;</span>\n        <span class=\"hljs-keyword\">return</span> mesh;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1186,1213"}}],"payload":{"tag":"h3","lines":"1185,1186"}}],"payload":{"tag":"h2","lines":"1148,1149"}},{"content":"&#x5341;&#x4e03;. &#x7a7a;&#x95f4;&#x5206;&#x5272;&#x7cfb;&#x7edf;","children":[{"content":"17.1 &#x516b;&#x53c9;&#x6811;","children":[{"content":"<pre data-lines=\"1217,1258\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Octree</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OctreeNode</span> \n    {\n        <span class=\"hljs-keyword\">public</span> AABB bounds;\n        <span class=\"hljs-keyword\">public</span> List&lt;GameObject&gt; objects;\n        <span class=\"hljs-keyword\">public</span> OctreeNode[] children;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> isLeaf;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">OctreeNode</span>(<span class=\"hljs-params\">AABB bounds</span>)</span> \n        {\n            <span class=\"hljs-keyword\">this</span>.bounds = bounds;\n            <span class=\"hljs-keyword\">this</span>.objects = <span class=\"hljs-keyword\">new</span> List&lt;GameObject&gt;();\n            <span class=\"hljs-keyword\">this</span>.children = <span class=\"hljs-keyword\">new</span> OctreeNode[<span class=\"hljs-number\">8</span>];\n            <span class=\"hljs-keyword\">this</span>.isLeaf = <span class=\"hljs-literal\">true</span>;\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Split</span>()</span> \n        {\n            Vector3 center = (bounds.min + bounds.max) * <span class=\"hljs-number\">0.5f</span>;\n            Vector3 extents = (bounds.max - bounds.min) * <span class=\"hljs-number\">0.5f</span>;\n            \n            <span class=\"hljs-comment\">// &#x521b;&#x5efa;8&#x4e2a;&#x5b50;&#x8282;&#x70b9;</span>\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">8</span>; i++) \n            {\n                Vector3 min = bounds.min;\n                Vector3 max = center;\n                \n                <span class=\"hljs-keyword\">if</span> ((i &amp; <span class=\"hljs-number\">1</span>) != <span class=\"hljs-number\">0</span>) { min.x = center.x; max.x = bounds.max.x; }\n                <span class=\"hljs-keyword\">if</span> ((i &amp; <span class=\"hljs-number\">2</span>) != <span class=\"hljs-number\">0</span>) { min.y = center.y; max.y = bounds.max.y; }\n                <span class=\"hljs-keyword\">if</span> ((i &amp; <span class=\"hljs-number\">4</span>) != <span class=\"hljs-number\">0</span>) { min.z = center.z; max.z = bounds.max.z; }\n                \n                children[i] = <span class=\"hljs-keyword\">new</span> OctreeNode(<span class=\"hljs-keyword\">new</span> AABB(min, max));\n            }\n            \n            isLeaf = <span class=\"hljs-literal\">false</span>;\n        }\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1217,1258"}}],"payload":{"tag":"h3","lines":"1216,1217"}},{"content":"17.2 BSP&#x6811;","children":[{"content":"<pre data-lines=\"1260,1384\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">BSPTree</span> \n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">BSPNode</span> \n    {\n        <span class=\"hljs-keyword\">public</span> Plane3D splitPlane;\n        <span class=\"hljs-keyword\">public</span> BSPNode front;\n        <span class=\"hljs-keyword\">public</span> BSPNode back;\n        <span class=\"hljs-keyword\">public</span> List&lt;Triangle3D&gt; triangles;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">BSPNode</span>(<span class=\"hljs-params\">List&lt;Triangle3D&gt; triangles</span>)</span> \n        {\n            <span class=\"hljs-keyword\">this</span>.triangles = triangles;\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Split</span>()</span> \n        {\n            <span class=\"hljs-comment\">// &#x9009;&#x62e9;&#x6700;&#x4f73;&#x5206;&#x5272;&#x5e73;&#x9762;</span>\n            splitPlane = ChooseSplitPlane();\n            \n            List&lt;Triangle3D&gt; frontList = <span class=\"hljs-keyword\">new</span> List&lt;Triangle3D&gt;();\n            List&lt;Triangle3D&gt; backList = <span class=\"hljs-keyword\">new</span> List&lt;Triangle3D&gt;();\n            \n            <span class=\"hljs-comment\">// &#x5206;&#x5272;&#x4e09;&#x89d2;&#x5f62;</span>\n            <span class=\"hljs-keyword\">foreach</span> (Triangle3D tri <span class=\"hljs-keyword\">in</span> triangles) \n            {\n                SplitTriangle(tri, splitPlane, frontList, backList);\n            }\n            \n            <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x5b50;&#x8282;&#x70b9;</span>\n            <span class=\"hljs-keyword\">if</span> (frontList.Count &gt; <span class=\"hljs-number\">0</span>) \n                front = <span class=\"hljs-keyword\">new</span> BSPNode(frontList);\n            \n            <span class=\"hljs-keyword\">if</span> (backList.Count &gt; <span class=\"hljs-number\">0</span>) \n                back = <span class=\"hljs-keyword\">new</span> BSPNode(backList);\n            \n            triangles.Clear();\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Plane3D <span class=\"hljs-title\">ChooseSplitPlane</span>()</span> \n        {\n            <span class=\"hljs-comment\">// &#x5b9e;&#x73b0;&#x7701;&#x7565;...</span>\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Plane3D();\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">SplitTriangle</span>(<span class=\"hljs-params\">\n            Triangle3D triangle, \n            Plane3D plane, \n            List&lt;Triangle3D&gt; frontList, \n            List&lt;Triangle3D&gt; backList</span>)</span> \n        {\n            <span class=\"hljs-comment\">// &#x5b9e;&#x73b0;&#x7701;&#x7565;...</span>\n        }\n    }\n} \n\n<span class=\"hljs-meta\">## &#x5341;&#x516b;. &#x9ad8;&#x7ea7;&#x7c92;&#x5b50;&#x7cfb;&#x7edf;</span>\n<span class=\"hljs-meta\">### 18.1 GPU&#x7c92;&#x5b50;&#x7cfb;&#x7edf;</span>\n```csharp\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">GPUParticleSystem</span>\n{\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">struct</span> Particle\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 position;\n        <span class=\"hljs-keyword\">public</span> Vector3 velocity;\n        <span class=\"hljs-keyword\">public</span> Vector4 color;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> size;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> life;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> rotation;\n    }\n    \n    <span class=\"hljs-keyword\">private</span> ComputeShader computeShader;\n    <span class=\"hljs-keyword\">private</span> ComputeBuffer particleBuffer;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">int</span> particleCount;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Initialize</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">int</span> count</span>)</span>\n    {\n        particleCount = count;\n        \n        <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x8ba1;&#x7b97;&#x7f13;&#x51b2;&#x533a;</span>\n        particleBuffer = <span class=\"hljs-keyword\">new</span> ComputeBuffer(\n            count, \n            <span class=\"hljs-keyword\">sizeof</span>(<span class=\"hljs-built_in\">float</span>) * <span class=\"hljs-number\">13</span>\n        );\n        \n        <span class=\"hljs-comment\">// &#x521d;&#x59cb;&#x5316;&#x7c92;&#x5b50;</span>\n        Particle[] particles = <span class=\"hljs-keyword\">new</span> Particle[count];\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; count; i++)\n        {\n            particles[i] = CreateRandomParticle();\n        }\n        \n        particleBuffer.SetData(particles);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>()</span>\n    {\n        <span class=\"hljs-comment\">// &#x8bbe;&#x7f6e;&#x8ba1;&#x7b97;&#x7740;&#x8272;&#x5668;&#x53c2;&#x6570;</span>\n        computeShader.SetFloat(<span class=\"hljs-string\">&quot;deltaTime&quot;</span>, Time.deltaTime);\n        computeShader.SetBuffer(<span class=\"hljs-number\">0</span>, <span class=\"hljs-string\">&quot;particles&quot;</span>, particleBuffer);\n        \n        <span class=\"hljs-comment\">// &#x8c03;&#x5ea6;&#x8ba1;&#x7b97;</span>\n        <span class=\"hljs-built_in\">int</span> threadGroups = Mathf.CeilToInt(particleCount / <span class=\"hljs-number\">256.0f</span>);\n        computeShader.Dispatch(<span class=\"hljs-number\">0</span>, threadGroups, <span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">1</span>);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Render</span>(<span class=\"hljs-params\">Camera camera</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x8bbe;&#x7f6e;&#x6750;&#x8d28;&#x53c2;&#x6570;</span>\n        material.SetBuffer(<span class=\"hljs-string\">&quot;particleBuffer&quot;</span>, particleBuffer);\n        material.SetMatrix(<span class=\"hljs-string\">&quot;viewMatrix&quot;</span>, camera.worldToCameraMatrix);\n        material.SetMatrix(<span class=\"hljs-string\">&quot;projectionMatrix&quot;</span>, \n            camera.projectionMatrix);\n        \n        <span class=\"hljs-comment\">// &#x7ed8;&#x5236;&#x7c92;&#x5b50;</span>\n        Graphics.DrawProcedural(\n            material, \n            <span class=\"hljs-keyword\">new</span> Bounds(Vector3.zero, Vector3.one * <span class=\"hljs-number\">100</span>),\n            MeshTopology.Points, \n            particleCount\n        );\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1260,1384"}}],"payload":{"tag":"h3","lines":"1259,1260"}}],"payload":{"tag":"h2","lines":"1214,1215"}},{"content":"&#x5341;&#x4e5d;. &#x5e03;&#x6599;&#x6a21;&#x62df;","children":[{"content":"19.1 &#x5f39;&#x7c27;&#x8d28;&#x70b9;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"1387,1527\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ClothSimulation</span>\n{\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">struct</span> Vertex\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 position;\n        <span class=\"hljs-keyword\">public</span> Vector3 oldPosition;\n        <span class=\"hljs-keyword\">public</span> Vector3 velocity;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">bool</span> isFixed;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> mass;\n    }\n    \n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">struct</span> Spring\n    {\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">int</span> vertexA;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">int</span> vertexB;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> restLength;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> stiffness;\n    }\n    \n    <span class=\"hljs-keyword\">private</span> Vertex[] vertices;\n    <span class=\"hljs-keyword\">private</span> Spring[] springs;\n    <span class=\"hljs-keyword\">private</span> Vector3 gravity = <span class=\"hljs-keyword\">new</span> Vector3(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">-9.81f</span>, <span class=\"hljs-number\">0</span>);\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> damping = <span class=\"hljs-number\">0.01f</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Initialize</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">int</span> width, <span class=\"hljs-built_in\">int</span> height</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x9876;&#x70b9;&#x7f51;&#x683c;</span>\n        vertices = <span class=\"hljs-keyword\">new</span> Vertex[width * height];\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">0</span>; y &lt; height; y++)\n        {\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">0</span>; x &lt; width; x++)\n            {\n                <span class=\"hljs-built_in\">int</span> index = y * width + x;\n                vertices[index] = <span class=\"hljs-keyword\">new</span> Vertex\n                {\n                    position = <span class=\"hljs-keyword\">new</span> Vector3(x, height, y),\n                    oldPosition = <span class=\"hljs-keyword\">new</span> Vector3(x, height, y),\n                    mass = <span class=\"hljs-number\">1.0f</span>,\n                    isFixed = y == height - <span class=\"hljs-number\">1</span> <span class=\"hljs-comment\">// &#x56fa;&#x5b9a;&#x9876;&#x90e8;&#x9876;&#x70b9;</span>\n                };\n            }\n        }\n        \n        <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x5f39;&#x7c27;&#x7ea6;&#x675f;</span>\n        List&lt;Spring&gt; springList = <span class=\"hljs-keyword\">new</span> List&lt;Spring&gt;();\n        \n        <span class=\"hljs-comment\">// &#x7ed3;&#x6784;&#x5f39;&#x7c27;</span>\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">0</span>; y &lt; height; y++)\n        {\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">0</span>; x &lt; width; x++)\n            {\n                <span class=\"hljs-built_in\">int</span> index = y * width + x;\n                \n                <span class=\"hljs-keyword\">if</span> (x &lt; width - <span class=\"hljs-number\">1</span>)\n                    AddSpring(springList, index, index + <span class=\"hljs-number\">1</span>);\n                    \n                <span class=\"hljs-keyword\">if</span> (y &lt; height - <span class=\"hljs-number\">1</span>)\n                    AddSpring(springList, index, index + width);\n            }\n        }\n        \n        <span class=\"hljs-comment\">// &#x526a;&#x5207;&#x5f39;&#x7c27;</span>\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">0</span>; y &lt; height - <span class=\"hljs-number\">1</span>; y++)\n        {\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">0</span>; x &lt; width - <span class=\"hljs-number\">1</span>; x++)\n            {\n                <span class=\"hljs-built_in\">int</span> index = y * width + x;\n                AddSpring(springList, index, index + width + <span class=\"hljs-number\">1</span>);\n                AddSpring(springList, index + <span class=\"hljs-number\">1</span>, index + width);\n            }\n        }\n        \n        springs = springList.ToArray();\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">AddSpring</span>(<span class=\"hljs-params\">\n        List&lt;Spring&gt; springs, \n        <span class=\"hljs-built_in\">int</span> vertexA, \n        <span class=\"hljs-built_in\">int</span> vertexB</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> restLength = Vector3.Distance(\n            vertices[vertexA].position,\n            vertices[vertexB].position\n        );\n        \n        springs.Add(<span class=\"hljs-keyword\">new</span> Spring\n        {\n            vertexA = vertexA,\n            vertexB = vertexB,\n            restLength = restLength,\n            stiffness = <span class=\"hljs-number\">100.0f</span>\n        });\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> deltaTime</span>)</span>\n    {\n        <span class=\"hljs-comment\">// Verlet&#x79ef;&#x5206;</span>\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; vertices.Length; i++)\n        {\n            <span class=\"hljs-keyword\">if</span> (vertices[i].isFixed) <span class=\"hljs-keyword\">continue</span>;\n            \n            Vector3 temp = vertices[i].position;\n            Vector3 velocity = vertices[i].position - \n                vertices[i].oldPosition;\n            \n            vertices[i].position += velocity * (<span class=\"hljs-number\">1.0f</span> - damping) + \n                gravity * deltaTime * deltaTime;\n            vertices[i].oldPosition = temp;\n        }\n        \n        <span class=\"hljs-comment\">// &#x7ea6;&#x675f;&#x6c42;&#x89e3;</span>\n        <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">int</span> iterations = <span class=\"hljs-number\">5</span>;\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; iterations; i++)\n        {\n            SolveConstraints();\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">SolveConstraints</span>()</span>\n    {\n        <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> spring <span class=\"hljs-keyword\">in</span> springs)\n        {\n            Vector3 delta = vertices[spring.vertexB].position - \n                vertices[spring.vertexA].position;\n            <span class=\"hljs-built_in\">float</span> currentLength = delta.magnitude;\n            <span class=\"hljs-built_in\">float</span> correction = (currentLength - spring.restLength) / \n                currentLength;\n            \n            <span class=\"hljs-keyword\">if</span> (!vertices[spring.vertexA].isFixed)\n                vertices[spring.vertexA].position += \n                    delta * correction * <span class=\"hljs-number\">0.5f</span>;\n                    \n            <span class=\"hljs-keyword\">if</span> (!vertices[spring.vertexB].isFixed)\n                vertices[spring.vertexB].position -= \n                    delta * correction * <span class=\"hljs-number\">0.5f</span>;\n        }\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1387,1527"}}],"payload":{"tag":"h3","lines":"1386,1387"}}],"payload":{"tag":"h2","lines":"1385,1386"}},{"content":"&#x4e8c;&#x5341;. &#x6d41;&#x4f53;&#x6a21;&#x62df;","children":[{"content":"20.1 SPH&#x6d41;&#x4f53;&#x6a21;&#x62df;","children":[{"content":"<pre data-lines=\"1530,1766\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SPHFluid</span>\n{\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">struct</span> Particle\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 position;\n        <span class=\"hljs-keyword\">public</span> Vector3 velocity;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> density;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> pressure;\n        <span class=\"hljs-keyword\">public</span> Vector3 force;\n    }\n    \n    <span class=\"hljs-keyword\">private</span> Particle[] particles;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> smoothingLength;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> particleMass;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> restDensity;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> pressureConstant;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> viscosity;\n    \n    <span class=\"hljs-keyword\">private</span> Dictionary&lt;Vector3Int, List&lt;<span class=\"hljs-built_in\">int</span>&gt;&gt; grid;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> cellSize;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Initialize</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">int</span> particleCount</span>)</span>\n    {\n        particles = <span class=\"hljs-keyword\">new</span> Particle[particleCount];\n        grid = <span class=\"hljs-keyword\">new</span> Dictionary&lt;Vector3Int, List&lt;<span class=\"hljs-built_in\">int</span>&gt;&gt;();\n        \n        <span class=\"hljs-comment\">// &#x521d;&#x59cb;&#x5316;&#x53c2;&#x6570;</span>\n        smoothingLength = <span class=\"hljs-number\">1.0f</span>;\n        particleMass = <span class=\"hljs-number\">1.0f</span>;\n        restDensity = <span class=\"hljs-number\">1000.0f</span>;\n        pressureConstant = <span class=\"hljs-number\">1000.0f</span>;\n        viscosity = <span class=\"hljs-number\">0.1f</span>;\n        cellSize = smoothingLength;\n        \n        <span class=\"hljs-comment\">// &#x521d;&#x59cb;&#x5316;&#x7c92;&#x5b50;</span>\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; particleCount; i++)\n        {\n            particles[i] = <span class=\"hljs-keyword\">new</span> Particle\n            {\n                position = Random.insideUnitSphere * <span class=\"hljs-number\">5</span>,\n                velocity = Vector3.zero,\n                density = <span class=\"hljs-number\">0</span>,\n                pressure = <span class=\"hljs-number\">0</span>,\n                force = Vector3.zero\n            };\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> deltaTime</span>)</span>\n    {\n        UpdateGrid();\n        CalculateDensityPressure();\n        CalculateForces();\n        IntegrateParticles(deltaTime);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">UpdateGrid</span>()</span>\n    {\n        grid.Clear();\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; particles.Length; i++)\n        {\n            Vector3Int cell = GetCell(particles[i].position);\n            \n            <span class=\"hljs-keyword\">if</span> (!grid.ContainsKey(cell))\n                grid[cell] = <span class=\"hljs-keyword\">new</span> List&lt;<span class=\"hljs-built_in\">int</span>&gt;();\n                \n            grid[cell].Add(i);\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Vector3Int <span class=\"hljs-title\">GetCell</span>(<span class=\"hljs-params\">Vector3 position</span>)</span>\n    {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Vector3Int(\n            Mathf.FloorToInt(position.x / cellSize),\n            Mathf.FloorToInt(position.y / cellSize),\n            Mathf.FloorToInt(position.z / cellSize)\n        );\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">CalculateDensityPressure</span>()</span>\n    {\n        <span class=\"hljs-built_in\">float</span> h2 = smoothingLength * smoothingLength;\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; particles.Length; i++)\n        {\n            <span class=\"hljs-built_in\">float</span> density = <span class=\"hljs-number\">0</span>;\n            Vector3Int cell = GetCell(particles[i].position);\n            \n            <span class=\"hljs-comment\">// &#x68c0;&#x67e5;&#x76f8;&#x90bb;&#x683c;&#x5b50;</span>\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">-1</span>; x &lt;= <span class=\"hljs-number\">1</span>; x++)\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">-1</span>; y &lt;= <span class=\"hljs-number\">1</span>; y++)\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> z = <span class=\"hljs-number\">-1</span>; z &lt;= <span class=\"hljs-number\">1</span>; z++)\n            {\n                Vector3Int nearCell = cell + <span class=\"hljs-keyword\">new</span> Vector3Int(x, y, z);\n                \n                <span class=\"hljs-keyword\">if</span> (!grid.ContainsKey(nearCell)) <span class=\"hljs-keyword\">continue</span>;\n                \n                <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-built_in\">int</span> j <span class=\"hljs-keyword\">in</span> grid[nearCell])\n                {\n                    Vector3 rij = particles[i].position - \n                        particles[j].position;\n                    <span class=\"hljs-built_in\">float</span> r2 = rij.sqrMagnitude;\n                    \n                    <span class=\"hljs-keyword\">if</span> (r2 &lt; h2)\n                    {\n                        density += particleMass * \n                            Kernel(Mathf.Sqrt(r2), smoothingLength);\n                    }\n                }\n            }\n            \n            particles[i].density = density;\n            particles[i].pressure = pressureConstant * \n                (density - restDensity);\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">Kernel</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> r, <span class=\"hljs-built_in\">float</span> h</span>)</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (r &gt; h) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;\n        \n        <span class=\"hljs-built_in\">float</span> volume = Mathf.PI * Mathf.Pow(h, <span class=\"hljs-number\">6</span>) / <span class=\"hljs-number\">64</span>;\n        <span class=\"hljs-keyword\">return</span> (<span class=\"hljs-number\">1.0f</span> / volume) * Mathf.Pow(h * h - r * r, <span class=\"hljs-number\">3</span>);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Vector3 <span class=\"hljs-title\">KernelGradient</span>(<span class=\"hljs-params\">Vector3 r, <span class=\"hljs-built_in\">float</span> h</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> length = r.magnitude;\n        <span class=\"hljs-keyword\">if</span> (length &gt; h) <span class=\"hljs-keyword\">return</span> Vector3.zero;\n        \n        <span class=\"hljs-built_in\">float</span> scale = <span class=\"hljs-number\">-945.0f</span> / (<span class=\"hljs-number\">32.0f</span> * Mathf.PI * \n            Mathf.Pow(h, <span class=\"hljs-number\">9</span>)) * Mathf.Pow(h * h - length * length, <span class=\"hljs-number\">2</span>);\n        <span class=\"hljs-keyword\">return</span> r * scale;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">CalculateForces</span>()</span>\n    {\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; particles.Length; i++)\n        {\n            Vector3 force = Vector3.zero;\n            Vector3Int cell = GetCell(particles[i].position);\n            \n            <span class=\"hljs-comment\">// &#x538b;&#x529b;&#x548c;&#x7c98;&#x6027;&#x529b;</span>\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">-1</span>; x &lt;= <span class=\"hljs-number\">1</span>; x++)\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">-1</span>; y &lt;= <span class=\"hljs-number\">1</span>; y++)\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> z = <span class=\"hljs-number\">-1</span>; z &lt;= <span class=\"hljs-number\">1</span>; z++)\n            {\n                Vector3Int nearCell = cell + <span class=\"hljs-keyword\">new</span> Vector3Int(x, y, z);\n                \n                <span class=\"hljs-keyword\">if</span> (!grid.ContainsKey(nearCell)) <span class=\"hljs-keyword\">continue</span>;\n                \n                <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-built_in\">int</span> j <span class=\"hljs-keyword\">in</span> grid[nearCell])\n                {\n                    <span class=\"hljs-keyword\">if</span> (i == j) <span class=\"hljs-keyword\">continue</span>;\n                    \n                    Vector3 rij = particles[i].position - \n                        particles[j].position;\n                    <span class=\"hljs-built_in\">float</span> length = rij.magnitude;\n                    \n                    <span class=\"hljs-keyword\">if</span> (length &lt; smoothingLength)\n                    {\n                        <span class=\"hljs-comment\">// &#x538b;&#x529b;&#x529b;</span>\n                        Vector3 pressureForce = -rij.normalized * \n                            particleMass * \n                            (particles[i].pressure + \n                             particles[j].pressure) / \n                            (<span class=\"hljs-number\">2</span> * particles[j].density) * \n                            KernelGradient(rij, smoothingLength).magnitude;\n                        \n                        <span class=\"hljs-comment\">// &#x7c98;&#x6027;&#x529b;</span>\n                        Vector3 viscosityForce = viscosity * \n                            particleMass * \n                            (particles[j].velocity - \n                             particles[i].velocity) / \n                            particles[j].density * \n                            KernelGradient(rij, smoothingLength).magnitude;\n                        \n                        force += pressureForce + viscosityForce;\n                    }\n                }\n            }\n            \n            <span class=\"hljs-comment\">// &#x91cd;&#x529b;</span>\n            force += Vector3.down * <span class=\"hljs-number\">9.81f</span> * particles[i].density;\n            \n            particles[i].force = force;\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">IntegrateParticles</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> deltaTime</span>)</span>\n    {\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; particles.Length; i++)\n        {\n            <span class=\"hljs-comment\">// &#x66f4;&#x65b0;&#x901f;&#x5ea6;&#x548c;&#x4f4d;&#x7f6e;</span>\n            particles[i].velocity += particles[i].force / \n                particles[i].density * deltaTime;\n            particles[i].position += particles[i].velocity * deltaTime;\n            \n            <span class=\"hljs-comment\">// &#x8fb9;&#x754c;&#x5904;&#x7406;</span>\n            HandleBoundaryCollisions(i);\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">HandleBoundaryCollisions</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">int</span> index</span>)</span>\n    {\n        <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">float</span> BOUNDARY = <span class=\"hljs-number\">10.0f</span>;\n        <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">float</span> DAMPING = <span class=\"hljs-number\">0.5f</span>;\n        \n        Vector3 position = particles[index].position;\n        Vector3 velocity = particles[index].velocity;\n        \n        <span class=\"hljs-keyword\">if</span> (Mathf.Abs(position.x) &gt; BOUNDARY)\n        {\n            position.x = BOUNDARY * Mathf.Sign(position.x);\n            velocity.x = -velocity.x * DAMPING;\n        }\n        \n        <span class=\"hljs-keyword\">if</span> (Mathf.Abs(position.y) &gt; BOUNDARY)\n        {\n            position.y = BOUNDARY * Mathf.Sign(position.y);\n            velocity.y = -velocity.y * DAMPING;\n        }\n        \n        <span class=\"hljs-keyword\">if</span> (Mathf.Abs(position.z) &gt; BOUNDARY)\n        {\n            position.z = BOUNDARY * Mathf.Sign(position.z);\n            velocity.z = -velocity.z * DAMPING;\n        }\n        \n        particles[index].position = position;\n        particles[index].velocity = velocity;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1530,1766"}}],"payload":{"tag":"h3","lines":"1529,1530"}}],"payload":{"tag":"h2","lines":"1528,1529"}},{"content":"&#x4e8c;&#x5341;&#x4e00;. &#x7834;&#x788e;&#x6548;&#x679c;","children":[{"content":"21.1 Voronoi&#x5206;&#x89e3;","children":[{"content":"<pre data-lines=\"1769,1885\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">VoronoiFracture</span>\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> Cell\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 site;\n        <span class=\"hljs-keyword\">public</span> List&lt;Vector3&gt; vertices;\n        <span class=\"hljs-keyword\">public</span> List&lt;<span class=\"hljs-built_in\">int</span>&gt; triangles;\n    }\n    \n    <span class=\"hljs-keyword\">private</span> List&lt;Cell&gt; cells;\n    <span class=\"hljs-keyword\">private</span> Bounds bounds;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">GenerateFracture</span>(<span class=\"hljs-params\">\n        Mesh mesh, \n        <span class=\"hljs-built_in\">int</span> cellCount, \n        <span class=\"hljs-built_in\">float</span> noiseScale</span>)</span>\n    {\n        cells = <span class=\"hljs-keyword\">new</span> List&lt;Cell&gt;();\n        bounds = mesh.bounds;\n        \n        <span class=\"hljs-comment\">// &#x751f;&#x6210;Voronoi&#x7ad9;&#x70b9;</span>\n        List&lt;Vector3&gt; sites = GenerateRandomSites(cellCount);\n        \n        <span class=\"hljs-comment\">// &#x4e3a;&#x6bcf;&#x4e2a;&#x9876;&#x70b9;&#x627e;&#x5230;&#x6700;&#x8fd1;&#x7684;&#x7ad9;&#x70b9;</span>\n        Vector3[] vertices = mesh.vertices;\n        <span class=\"hljs-built_in\">int</span>[] triangles = mesh.triangles;\n        \n        Dictionary&lt;<span class=\"hljs-built_in\">int</span>, List&lt;<span class=\"hljs-built_in\">int</span>&gt;&gt; cellTriangles = \n            <span class=\"hljs-keyword\">new</span> Dictionary&lt;<span class=\"hljs-built_in\">int</span>, List&lt;<span class=\"hljs-built_in\">int</span>&gt;&gt;();\n            \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; triangles.Length; i += <span class=\"hljs-number\">3</span>)\n        {\n            Vector3 center = (vertices[triangles[i]] + \n                vertices[triangles[i + <span class=\"hljs-number\">1</span>]] + \n                vertices[triangles[i + <span class=\"hljs-number\">2</span>]]) / <span class=\"hljs-number\">3</span>;\n                \n            <span class=\"hljs-built_in\">int</span> nearestSite = FindNearestSite(center, sites);\n            \n            <span class=\"hljs-keyword\">if</span> (!cellTriangles.ContainsKey(nearestSite))\n                cellTriangles[nearestSite] = <span class=\"hljs-keyword\">new</span> List&lt;<span class=\"hljs-built_in\">int</span>&gt;();\n                \n            cellTriangles[nearestSite].Add(triangles[i]);\n            cellTriangles[nearestSite].Add(triangles[i + <span class=\"hljs-number\">1</span>]);\n            cellTriangles[nearestSite].Add(triangles[i + <span class=\"hljs-number\">2</span>]);\n        }\n        \n        <span class=\"hljs-comment\">// &#x521b;&#x5efa;&#x5355;&#x5143;&#x683c;&#x7f51;&#x683c;</span>\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; sites.Count; i++)\n        {\n            <span class=\"hljs-keyword\">if</span> (!cellTriangles.ContainsKey(i))\n                <span class=\"hljs-keyword\">continue</span>;\n                \n            Cell cell = <span class=\"hljs-keyword\">new</span> Cell\n            {\n                site = sites[i],\n                vertices = <span class=\"hljs-keyword\">new</span> List&lt;Vector3&gt;(),\n                triangles = <span class=\"hljs-keyword\">new</span> List&lt;<span class=\"hljs-built_in\">int</span>&gt;()\n            };\n            \n            <span class=\"hljs-comment\">// &#x91cd;&#x5efa;&#x9876;&#x70b9;&#x548c;&#x4e09;&#x89d2;&#x5f62;</span>\n            Dictionary&lt;<span class=\"hljs-built_in\">int</span>, <span class=\"hljs-built_in\">int</span>&gt; vertexMap = \n                <span class=\"hljs-keyword\">new</span> Dictionary&lt;<span class=\"hljs-built_in\">int</span>, <span class=\"hljs-built_in\">int</span>&gt;();\n            \n            <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-built_in\">int</span> oldTriIndex <span class=\"hljs-keyword\">in</span> cellTriangles[i])\n            {\n                <span class=\"hljs-keyword\">if</span> (!vertexMap.ContainsKey(oldTriIndex))\n                {\n                    vertexMap[oldTriIndex] = cell.vertices.Count;\n                    cell.vertices.Add(vertices[oldTriIndex]);\n                }\n                \n                cell.triangles.Add(vertexMap[oldTriIndex]);\n            }\n            \n            cells.Add(cell);\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> List&lt;Vector3&gt; <span class=\"hljs-title\">GenerateRandomSites</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">int</span> count</span>)</span>\n    {\n        List&lt;Vector3&gt; sites = <span class=\"hljs-keyword\">new</span> List&lt;Vector3&gt;();\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; count; i++)\n        {\n            Vector3 site = <span class=\"hljs-keyword\">new</span> Vector3(\n                Random.Range(bounds.min.x, bounds.max.x),\n                Random.Range(bounds.min.y, bounds.max.y),\n                Random.Range(bounds.min.z, bounds.max.z)\n            );\n            \n            sites.Add(site);\n        }\n        \n        <span class=\"hljs-keyword\">return</span> sites;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">int</span> <span class=\"hljs-title\">FindNearestSite</span>(<span class=\"hljs-params\">Vector3 point, List&lt;Vector3&gt; sites</span>)</span>\n    {\n        <span class=\"hljs-built_in\">int</span> nearest = <span class=\"hljs-number\">0</span>;\n        <span class=\"hljs-built_in\">float</span> minDist = <span class=\"hljs-built_in\">float</span>.MaxValue;\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; sites.Count; i++)\n        {\n            <span class=\"hljs-built_in\">float</span> dist = Vector3.Distance(point, sites[i]);\n            <span class=\"hljs-keyword\">if</span> (dist &lt; minDist)\n            {\n                minDist = dist;\n                nearest = i;\n            }\n        }\n        \n        <span class=\"hljs-keyword\">return</span> nearest;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1769,1885"}}],"payload":{"tag":"h3","lines":"1768,1769"}}],"payload":{"tag":"h2","lines":"1767,1768"}},{"content":"&#x4e8c;&#x5341;&#x4e8c;. &#x5929;&#x6c14;&#x7cfb;&#x7edf;","children":[{"content":"22.1 &#x4f53;&#x79ef;&#x4e91;&#x6e32;&#x67d3;","children":[{"content":"<pre data-lines=\"1888,2052\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">VolumetricClouds</span>\n{\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">struct</span> CloudData\n    {\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> density;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> temperature;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> humidity;\n        <span class=\"hljs-keyword\">public</span> Vector3 windVelocity;\n    }\n    \n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">int</span> GRID_SIZE = <span class=\"hljs-number\">64</span>;\n    <span class=\"hljs-keyword\">private</span> CloudData[,,] grid;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> cellSize = <span class=\"hljs-number\">100.0f</span>;\n    <span class=\"hljs-keyword\">private</span> Vector3 windDirection = Vector3.right;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> windSpeed = <span class=\"hljs-number\">10.0f</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Initialize</span>()</span>\n    {\n        grid = <span class=\"hljs-keyword\">new</span> CloudData[GRID_SIZE, GRID_SIZE, GRID_SIZE];\n        \n        <span class=\"hljs-comment\">// &#x521d;&#x59cb;&#x5316;&#x4e91;&#x5c42;&#x6570;&#x636e;</span>\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">0</span>; x &lt; GRID_SIZE; x++)\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">0</span>; y &lt; GRID_SIZE; y++)\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> z = <span class=\"hljs-number\">0</span>; z &lt; GRID_SIZE; z++)\n        {\n            <span class=\"hljs-built_in\">float</span> height = y / (<span class=\"hljs-built_in\">float</span>)GRID_SIZE;\n            \n            grid[x, y, z] = <span class=\"hljs-keyword\">new</span> CloudData\n            {\n                density = GenerateBaseDensity(x, y, z),\n                temperature = <span class=\"hljs-number\">20.0f</span> - height * <span class=\"hljs-number\">40.0f</span>,\n                humidity = Mathf.Lerp(<span class=\"hljs-number\">0.3f</span>, <span class=\"hljs-number\">0.9f</span>, height),\n                windVelocity = windDirection * windSpeed\n            };\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">GenerateBaseDensity</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">int</span> x, <span class=\"hljs-built_in\">int</span> y, <span class=\"hljs-built_in\">int</span> z</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> height = y / (<span class=\"hljs-built_in\">float</span>)GRID_SIZE;\n        \n        <span class=\"hljs-comment\">// &#x4f7f;&#x7528;&#x67cf;&#x6797;&#x566a;&#x58f0;&#x751f;&#x6210;&#x57fa;&#x7840;&#x4e91;&#x5c42;</span>\n        <span class=\"hljs-built_in\">float</span> baseNoise = Mathf.PerlinNoise(\n            x * <span class=\"hljs-number\">0.1f</span>,\n            z * <span class=\"hljs-number\">0.1f</span>\n        );\n        \n        <span class=\"hljs-comment\">// &#x6dfb;&#x52a0;&#x7ec6;&#x8282;&#x566a;&#x58f0;</span>\n        <span class=\"hljs-built_in\">float</span> detailNoise = Mathf.PerlinNoise(\n            x * <span class=\"hljs-number\">0.3f</span> + <span class=\"hljs-number\">100</span>,\n            z * <span class=\"hljs-number\">0.3f</span> + <span class=\"hljs-number\">100</span>\n        );\n        \n        <span class=\"hljs-comment\">// &#x9ad8;&#x5ea6;&#x8870;&#x51cf;</span>\n        <span class=\"hljs-built_in\">float</span> heightFalloff = Mathf.Exp(-height * <span class=\"hljs-number\">2.0f</span>);\n        \n        <span class=\"hljs-keyword\">return</span> Mathf.Clamp01(\n            (baseNoise * <span class=\"hljs-number\">0.7f</span> + detailNoise * <span class=\"hljs-number\">0.3f</span>) * \n            heightFalloff\n        );\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Update</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> deltaTime</span>)</span>\n    {\n        CloudData[,,] newGrid = <span class=\"hljs-keyword\">new</span> CloudData[GRID_SIZE, \n            GRID_SIZE, GRID_SIZE];\n            \n        <span class=\"hljs-comment\">// &#x6a21;&#x62df;&#x4e91;&#x5c42;&#x6f14;&#x53d8;</span>\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> x = <span class=\"hljs-number\">0</span>; x &lt; GRID_SIZE; x++)\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> y = <span class=\"hljs-number\">0</span>; y &lt; GRID_SIZE; y++)\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> z = <span class=\"hljs-number\">0</span>; z &lt; GRID_SIZE; z++)\n        {\n            CloudData cell = grid[x, y, z];\n            \n            <span class=\"hljs-comment\">// &#x5e94;&#x7528;&#x98ce;&#x529b;</span>\n            Vector3 windOffset = cell.windVelocity * deltaTime;\n            <span class=\"hljs-built_in\">int</span> newX = Mathf.RoundToInt(x + windOffset.x);\n            <span class=\"hljs-built_in\">int</span> newZ = Mathf.RoundToInt(z + windOffset.z);\n            \n            newX = (newX + GRID_SIZE) % GRID_SIZE;\n            newZ = (newZ + GRID_SIZE) % GRID_SIZE;\n            \n            <span class=\"hljs-comment\">// &#x6e29;&#x5ea6;&#x5bf9;&#x6d41;</span>\n            <span class=\"hljs-built_in\">float</span> tempDiff = y &lt; GRID_SIZE - <span class=\"hljs-number\">1</span> ? \n                grid[x, y + <span class=\"hljs-number\">1</span>, z].temperature - cell.temperature : <span class=\"hljs-number\">0</span>;\n            cell.temperature += tempDiff * <span class=\"hljs-number\">0.1f</span> * deltaTime;\n            \n            <span class=\"hljs-comment\">// &#x6e7f;&#x5ea6;&#x6269;&#x6563;</span>\n            <span class=\"hljs-built_in\">float</span> humidityDiff = <span class=\"hljs-number\">0</span>;\n            <span class=\"hljs-keyword\">if</span> (x &gt; <span class=\"hljs-number\">0</span>) humidityDiff += \n                grid[x<span class=\"hljs-number\">-1</span>, y, z].humidity - cell.humidity;\n            <span class=\"hljs-keyword\">if</span> (x &lt; GRID_SIZE<span class=\"hljs-number\">-1</span>) humidityDiff += \n                grid[x+<span class=\"hljs-number\">1</span>, y, z].humidity - cell.humidity;\n            <span class=\"hljs-keyword\">if</span> (z &gt; <span class=\"hljs-number\">0</span>) humidityDiff += \n                grid[x, y, z<span class=\"hljs-number\">-1</span>].humidity - cell.humidity;\n            <span class=\"hljs-keyword\">if</span> (z &lt; GRID_SIZE<span class=\"hljs-number\">-1</span>) humidityDiff += \n                grid[x, y, z+<span class=\"hljs-number\">1</span>].humidity - cell.humidity;\n            \n            cell.humidity += humidityDiff * <span class=\"hljs-number\">0.1f</span> * deltaTime;\n            \n            <span class=\"hljs-comment\">// &#x4e91;&#x5bc6;&#x5ea6;&#x53d8;&#x5316;</span>\n            <span class=\"hljs-built_in\">float</span> densityChange = (cell.humidity - <span class=\"hljs-number\">0.5f</span>) * \n                Mathf.Exp(-Mathf.Abs(cell.temperature)) * \n                deltaTime;\n            cell.density = Mathf.Clamp01(\n                cell.density + densityChange\n            );\n            \n            newGrid[newX, y, newZ] = cell;\n        }\n        \n        grid = newGrid;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">SampleDensity</span>(<span class=\"hljs-params\">Vector3 worldPosition</span>)</span>\n    {\n        Vector3 gridPosition = worldPosition / cellSize;\n        \n        <span class=\"hljs-built_in\">int</span> x = Mathf.FloorToInt(gridPosition.x);\n        <span class=\"hljs-built_in\">int</span> y = Mathf.FloorToInt(gridPosition.y);\n        <span class=\"hljs-built_in\">int</span> z = Mathf.FloorToInt(gridPosition.z);\n        \n        <span class=\"hljs-keyword\">if</span> (x &lt; <span class=\"hljs-number\">0</span> || x &gt;= GRID_SIZE - <span class=\"hljs-number\">1</span> ||\n            y &lt; <span class=\"hljs-number\">0</span> || y &gt;= GRID_SIZE - <span class=\"hljs-number\">1</span> ||\n            z &lt; <span class=\"hljs-number\">0</span> || z &gt;= GRID_SIZE - <span class=\"hljs-number\">1</span>)\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;\n            \n        Vector3 fraction = gridPosition - \n            <span class=\"hljs-keyword\">new</span> Vector3(x, y, z);\n            \n        <span class=\"hljs-comment\">// &#x4e09;&#x7ebf;&#x6027;&#x63d2;&#x503c;</span>\n        <span class=\"hljs-keyword\">return</span> TrilinearInterpolation(\n            grid[x, y, z].density,\n            grid[x + <span class=\"hljs-number\">1</span>, y, z].density,\n            grid[x, y + <span class=\"hljs-number\">1</span>, z].density,\n            grid[x + <span class=\"hljs-number\">1</span>, y + <span class=\"hljs-number\">1</span>, z].density,\n            grid[x, y, z + <span class=\"hljs-number\">1</span>].density,\n            grid[x + <span class=\"hljs-number\">1</span>, y, z + <span class=\"hljs-number\">1</span>].density,\n            grid[x, y + <span class=\"hljs-number\">1</span>, z + <span class=\"hljs-number\">1</span>].density,\n            grid[x + <span class=\"hljs-number\">1</span>, y + <span class=\"hljs-number\">1</span>, z + <span class=\"hljs-number\">1</span>].density,\n            fraction\n        );\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">TrilinearInterpolation</span>(<span class=\"hljs-params\">\n        <span class=\"hljs-built_in\">float</span> c000, <span class=\"hljs-built_in\">float</span> c100,\n        <span class=\"hljs-built_in\">float</span> c010, <span class=\"hljs-built_in\">float</span> c110,\n        <span class=\"hljs-built_in\">float</span> c001, <span class=\"hljs-built_in\">float</span> c101,\n        <span class=\"hljs-built_in\">float</span> c011, <span class=\"hljs-built_in\">float</span> c111,\n        Vector3 fraction</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> c00 = Mathf.Lerp(c000, c100, fraction.x);\n        <span class=\"hljs-built_in\">float</span> c01 = Mathf.Lerp(c001, c101, fraction.x);\n        <span class=\"hljs-built_in\">float</span> c10 = Mathf.Lerp(c010, c110, fraction.x);\n        <span class=\"hljs-built_in\">float</span> c11 = Mathf.Lerp(c011, c111, fraction.x);\n        \n        <span class=\"hljs-built_in\">float</span> c0 = Mathf.Lerp(c00, c10, fraction.y);\n        <span class=\"hljs-built_in\">float</span> c1 = Mathf.Lerp(c01, c11, fraction.y);\n        \n        <span class=\"hljs-keyword\">return</span> Mathf.Lerp(c0, c1, fraction.z);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"1888,2052"}}],"payload":{"tag":"h3","lines":"1887,1888"}}],"payload":{"tag":"h2","lines":"1886,1887"}},{"content":"&#x4e8c;&#x5341;&#x4e09;. &#x521a;&#x4f53;&#x52a8;&#x529b;&#x5b66;&#x7cfb;&#x7edf;","children":[{"content":"23.1 &#x57fa;&#x7840;&#x521a;&#x4f53;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"2055,2093\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">RigidBody3D</span>\n{\n    <span class=\"hljs-keyword\">public</span> Vector3 Position { <span class=\"hljs-keyword\">get</span>; <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">set</span>; }\n    <span class=\"hljs-keyword\">public</span> Quaternion Rotation { <span class=\"hljs-keyword\">get</span>; <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">set</span>; }\n    <span class=\"hljs-keyword\">public</span> Vector3 LinearVelocity { <span class=\"hljs-keyword\">get</span>; <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">set</span>; }\n    <span class=\"hljs-keyword\">public</span> Vector3 AngularVelocity { <span class=\"hljs-keyword\">get</span>; <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">set</span>; }\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> Mass { <span class=\"hljs-keyword\">get</span>; <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">set</span>; }\n    <span class=\"hljs-keyword\">public</span> Matrix3x3 InertiaTensor { <span class=\"hljs-keyword\">get</span>; <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">set</span>; }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">ApplyForce</span>(<span class=\"hljs-params\">Vector3 force, Vector3 point</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x7ebf;&#x6027;&#x52a0;&#x901f;&#x5ea6;</span>\n        Vector3 linearAcceleration = force / Mass;\n        LinearVelocity += linearAcceleration * Time.deltaTime;\n        \n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x529b;&#x77e9;&#x548c;&#x89d2;&#x52a0;&#x901f;&#x5ea6;</span>\n        Vector3 torque = Vector3.Cross(point - Position, force);\n        Vector3 angularAcceleration = InertiaTensor.Inverse * torque;\n        AngularVelocity += angularAcceleration * Time.deltaTime;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Integrate</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> deltaTime</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x66f4;&#x65b0;&#x4f4d;&#x7f6e;</span>\n        Position += LinearVelocity * deltaTime;\n        \n        <span class=\"hljs-comment\">// &#x66f4;&#x65b0;&#x65cb;&#x8f6c;</span>\n        Quaternion angularRotation = <span class=\"hljs-keyword\">new</span> Quaternion(\n            AngularVelocity.x * deltaTime,\n            AngularVelocity.y * deltaTime,\n            AngularVelocity.z * deltaTime,\n            <span class=\"hljs-number\">0</span>\n        );\n        Rotation = (Rotation + (angularRotation * Rotation) * <span class=\"hljs-number\">0.5f</span>).normalized;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2055,2093"}}],"payload":{"tag":"h3","lines":"2054,2055"}},{"content":"23.2 &#x9ad8;&#x7ea7;&#x521a;&#x4f53;&#x7279;&#x6027;","children":[{"content":"<pre data-lines=\"2095,2139\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">AdvancedRigidBody</span> : <span class=\"hljs-title\">RigidBody3D</span>\n{\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> restitution;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> friction;\n    <span class=\"hljs-keyword\">private</span> Vector3 gravity = <span class=\"hljs-keyword\">new</span> Vector3(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">-9.81f</span>, <span class=\"hljs-number\">0</span>);\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">ApplyGravity</span>()</span>\n    {\n        ApplyForce(Mass * gravity, Position);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">HandleCollision</span>(<span class=\"hljs-params\">AdvancedRigidBody other, Vector3 normal, Vector3 point</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x76f8;&#x5bf9;&#x901f;&#x5ea6;</span>\n        Vector3 relativeVel = LinearVelocity - other.LinearVelocity;\n        \n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x51b2;&#x91cf;</span>\n        <span class=\"hljs-built_in\">float</span> normalVel = Vector3.Dot(relativeVel, normal);\n        <span class=\"hljs-keyword\">if</span> (normalVel &gt; <span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">return</span>; <span class=\"hljs-comment\">// &#x7269;&#x4f53;&#x5df2;&#x7ecf;&#x5206;&#x79bb;</span>\n        \n        <span class=\"hljs-built_in\">float</span> j = -(<span class=\"hljs-number\">1</span> + restitution) * normalVel;\n        j /= <span class=\"hljs-number\">1</span>/Mass + <span class=\"hljs-number\">1</span>/other.Mass;\n        \n        <span class=\"hljs-comment\">// &#x5e94;&#x7528;&#x51b2;&#x91cf;</span>\n        Vector3 impulse = j * normal;\n        LinearVelocity += impulse / Mass;\n        other.LinearVelocity -= impulse / other.Mass;\n        \n        <span class=\"hljs-comment\">// &#x5904;&#x7406;&#x6469;&#x64e6;&#x529b;</span>\n        Vector3 tangent = relativeVel - (Vector3.Dot(relativeVel, normal) * normal);\n        <span class=\"hljs-keyword\">if</span>(tangent.magnitude &gt; <span class=\"hljs-number\">0.0001f</span>)\n        {\n            tangent.Normalize();\n            <span class=\"hljs-built_in\">float</span> jt = -Vector3.Dot(relativeVel, tangent);\n            jt /= <span class=\"hljs-number\">1</span>/Mass + <span class=\"hljs-number\">1</span>/other.Mass;\n            \n            Vector3 frictionImpulse = friction * jt * tangent;\n            LinearVelocity += frictionImpulse / Mass;\n            other.LinearVelocity -= frictionImpulse / other.Mass;\n        }\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2095,2139"}}],"payload":{"tag":"h3","lines":"2094,2095"}}],"payload":{"tag":"h2","lines":"2053,2054"}},{"content":"&#x4e8c;&#x5341;&#x56db;. &#x9ad8;&#x7ea7;&#x78b0;&#x649e;&#x68c0;&#x6d4b;","children":[{"content":"24.1 &#x5206;&#x79bb;&#x8f74;&#x5b9a;&#x7406;&#xff08;SAT&#xff09;&#x5b9e;&#x73b0;","children":[{"content":"<pre data-lines=\"2142,2192\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SATCollisionDetector</span>\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> Projection\n    {\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> min, max;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">TestCollision</span>(<span class=\"hljs-params\">ConvexHull hullA, ConvexHull hullB</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x83b7;&#x53d6;&#x6240;&#x6709;&#x53ef;&#x80fd;&#x7684;&#x5206;&#x79bb;&#x8f74;</span>\n        List&lt;Vector3&gt; axes = GetSeparatingAxes(hullA, hullB);\n        \n        <span class=\"hljs-keyword\">foreach</span>(Vector3 axis <span class=\"hljs-keyword\">in</span> axes)\n        {\n            <span class=\"hljs-comment\">// &#x5728;&#x8f74;&#x4e0a;&#x6295;&#x5f71;&#x4e24;&#x4e2a;&#x51f8;&#x5305;</span>\n            Projection projA = Project(hullA, axis);\n            Projection projB = Project(hullB, axis);\n            \n            <span class=\"hljs-comment\">// &#x68c0;&#x67e5;&#x6295;&#x5f71;&#x662f;&#x5426;&#x91cd;&#x53e0;</span>\n            <span class=\"hljs-keyword\">if</span>(!OverlapOnAxis(projA, projB))\n            {\n                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>; <span class=\"hljs-comment\">// &#x627e;&#x5230;&#x5206;&#x79bb;&#x8f74;&#xff0c;&#x4e0d;&#x76f8;&#x4ea4;</span>\n            }\n        }\n        \n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span>; <span class=\"hljs-comment\">// &#x6240;&#x6709;&#x8f74;&#x90fd;&#x91cd;&#x53e0;&#xff0c;&#x5b58;&#x5728;&#x78b0;&#x649e;</span>\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> Projection <span class=\"hljs-title\">Project</span>(<span class=\"hljs-params\">ConvexHull hull, Vector3 axis</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> min = <span class=\"hljs-built_in\">float</span>.MaxValue;\n        <span class=\"hljs-built_in\">float</span> max = <span class=\"hljs-built_in\">float</span>.MinValue;\n        \n        <span class=\"hljs-keyword\">foreach</span>(Vector3 vertex <span class=\"hljs-keyword\">in</span> hull.vertices)\n        {\n            <span class=\"hljs-built_in\">float</span> proj = Vector3.Dot(vertex, axis);\n            min = Mathf.Min(min, proj);\n            max = Mathf.Max(max, proj);\n        }\n        \n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Projection { min = min, max = max };\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">OverlapOnAxis</span>(<span class=\"hljs-params\">Projection projA, Projection projB</span>)</span>\n    {\n        <span class=\"hljs-keyword\">return</span> projA.max &gt;= projB.min &amp;&amp; projB.max &gt;= projA.min;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2142,2192"}}],"payload":{"tag":"h3","lines":"2141,2142"}}],"payload":{"tag":"h2","lines":"2140,2141"}},{"content":"&#x4e8c;&#x5341;&#x4e94;. &#x7ea6;&#x675f;&#x6c42;&#x89e3;&#x7cfb;&#x7edf;","children":[{"content":"25.1 &#x57fa;&#x7840;&#x7ea6;&#x675f;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"2195,2224\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">abstract</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Constraint</span>\n{\n    <span class=\"hljs-keyword\">protected</span> RigidBody3D bodyA;\n    <span class=\"hljs-keyword\">protected</span> RigidBody3D bodyB;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">abstract</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Solve</span>()</span>;\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">abstract</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Initialize</span>()</span>;\n}\n\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">DistanceConstraint</span> : <span class=\"hljs-title\">Constraint</span>\n{\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> targetDistance;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> stiffness;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">override</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Solve</span>()</span>\n    {\n        Vector3 direction = bodyB.Position - bodyA.Position;\n        <span class=\"hljs-built_in\">float</span> currentDistance = direction.magnitude;\n        direction.Normalize();\n        \n        <span class=\"hljs-built_in\">float</span> error = currentDistance - targetDistance;\n        Vector3 correction = direction * error * stiffness;\n        \n        bodyA.Position += correction * <span class=\"hljs-number\">0.5f</span>;\n        bodyB.Position -= correction * <span class=\"hljs-number\">0.5f</span>;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2195,2224"}}],"payload":{"tag":"h3","lines":"2194,2195"}}],"payload":{"tag":"h2","lines":"2193,2194"}},{"content":"&#x4e8c;&#x5341;&#x516d;. &#x8fde;&#x7eed;&#x78b0;&#x649e;&#x68c0;&#x6d4b;","children":[{"content":"26.1 &#x626b;&#x63a0;&#x6d4b;&#x8bd5;","children":[{"content":"<pre data-lines=\"2227,2273\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SweepTest</span>\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> SweepResult\n    {\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> time;      <span class=\"hljs-comment\">// &#x78b0;&#x649e;&#x65f6;&#x95f4; [0,1]</span>\n        <span class=\"hljs-keyword\">public</span> Vector3 point;   <span class=\"hljs-comment\">// &#x78b0;&#x649e;&#x70b9;</span>\n        <span class=\"hljs-keyword\">public</span> Vector3 normal;  <span class=\"hljs-comment\">// &#x78b0;&#x649e;&#x6cd5;&#x7ebf;</span>\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> SweepResult <span class=\"hljs-title\">SweepSpheres</span>(<span class=\"hljs-params\">\n        Vector3 posA, <span class=\"hljs-built_in\">float</span> radiusA, Vector3 velocityA,\n        Vector3 posB, <span class=\"hljs-built_in\">float</span> radiusB, Vector3 velocityB</span>)</span>\n    {\n        Vector3 relativeVel = velocityA - velocityB;\n        Vector3 relativePos = posA - posB;\n        <span class=\"hljs-built_in\">float</span> combinedRadius = radiusA + radiusB;\n        \n        <span class=\"hljs-comment\">// &#x6c42;&#x89e3;&#x4e8c;&#x6b21;&#x65b9;&#x7a0b;</span>\n        <span class=\"hljs-built_in\">float</span> a = Vector3.Dot(relativeVel, relativeVel);\n        <span class=\"hljs-built_in\">float</span> b = <span class=\"hljs-number\">2.0f</span> * Vector3.Dot(relativeVel, relativePos);\n        <span class=\"hljs-built_in\">float</span> c = Vector3.Dot(relativePos, relativePos) - \n                 combinedRadius * combinedRadius;\n        \n        <span class=\"hljs-built_in\">float</span> discriminant = b * b - <span class=\"hljs-number\">4.0f</span> * a * c;\n        \n        <span class=\"hljs-keyword\">if</span>(discriminant &lt; <span class=\"hljs-number\">0</span>)\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SweepResult { time = <span class=\"hljs-built_in\">float</span>.MaxValue };\n            \n        <span class=\"hljs-built_in\">float</span> time = (-b - Mathf.Sqrt(discriminant)) / (<span class=\"hljs-number\">2.0f</span> * a);\n        \n        <span class=\"hljs-keyword\">if</span>(time &lt; <span class=\"hljs-number\">0</span> || time &gt; <span class=\"hljs-number\">1</span>)\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SweepResult { time = <span class=\"hljs-built_in\">float</span>.MaxValue };\n            \n        Vector3 point = posA + velocityA * time;\n        Vector3 normal = (point - (posB + velocityB * time)).normalized;\n        \n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> SweepResult \n        {\n            time = time,\n            point = point,\n            normal = normal\n        };\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2227,2273"}}],"payload":{"tag":"h3","lines":"2226,2227"}}],"payload":{"tag":"h2","lines":"2225,2226"}},{"content":"&#x4e8c;&#x5341;&#x4e03;. &#x7269;&#x7406;&#x5f15;&#x64ce;&#x4f18;&#x5316;","children":[{"content":"27.1 &#x7a7a;&#x95f4;&#x5206;&#x533a;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"2276,2332\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OctreeNode</span>\n{\n    <span class=\"hljs-keyword\">public</span> Bounds bounds;\n    <span class=\"hljs-keyword\">public</span> List&lt;RigidBody3D&gt; objects;\n    <span class=\"hljs-keyword\">public</span> OctreeNode[] children;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">int</span> MAX_OBJECTS = <span class=\"hljs-number\">8</span>;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">int</span> MAX_DEPTH = <span class=\"hljs-number\">8</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Insert</span>(<span class=\"hljs-params\">RigidBody3D obj</span>)</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (!bounds.Contains(obj.Position))\n            <span class=\"hljs-keyword\">return</span>;\n            \n        <span class=\"hljs-keyword\">if</span> (objects.Count &lt; MAX_OBJECTS || depth &gt;= MAX_DEPTH)\n        {\n            objects.Add(obj);\n            <span class=\"hljs-keyword\">return</span>;\n        }\n        \n        <span class=\"hljs-keyword\">if</span> (children == <span class=\"hljs-literal\">null</span>)\n            Split();\n            \n        <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> child <span class=\"hljs-keyword\">in</span> children)\n            child.Insert(obj);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Split</span>()</span>\n    {\n        Vector3 center = bounds.center;\n        Vector3 extents = bounds.extents * <span class=\"hljs-number\">0.5f</span>;\n        children = <span class=\"hljs-keyword\">new</span> OctreeNode[<span class=\"hljs-number\">8</span>];\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">8</span>; i++)\n        {\n            Vector3 newCenter = center;\n            newCenter.x += ((i &amp; <span class=\"hljs-number\">1</span>) == <span class=\"hljs-number\">0</span> ? -extents.x : extents.x);\n            newCenter.y += ((i &amp; <span class=\"hljs-number\">2</span>) == <span class=\"hljs-number\">0</span> ? -extents.y : extents.y);\n            newCenter.z += ((i &amp; <span class=\"hljs-number\">4</span>) == <span class=\"hljs-number\">0</span> ? -extents.z : extents.z);\n            \n            children[i] = <span class=\"hljs-keyword\">new</span> OctreeNode\n            {\n                bounds = <span class=\"hljs-keyword\">new</span> Bounds(newCenter, extents * <span class=\"hljs-number\">2</span>),\n                objects = <span class=\"hljs-keyword\">new</span> List&lt;RigidBody3D&gt;()\n            };\n        }\n        \n        <span class=\"hljs-comment\">// &#x91cd;&#x65b0;&#x5206;&#x914d;&#x73b0;&#x6709;&#x5bf9;&#x8c61;</span>\n        <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> obj <span class=\"hljs-keyword\">in</span> objects)\n            <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> child <span class=\"hljs-keyword\">in</span> children)\n                child.Insert(obj);\n                \n        objects.Clear();\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2276,2332"}}],"payload":{"tag":"h3","lines":"2275,2276"}}],"payload":{"tag":"h2","lines":"2274,2275"}},{"content":"&#x4e8c;&#x5341;&#x516b;. &#x5149;&#x7ebf;&#x8ffd;&#x8e2a;&#x7cfb;&#x7edf;","children":[{"content":"28.1 &#x57fa;&#x7840;&#x5149;&#x7ebf;&#x8ffd;&#x8e2a;&#x5668;","children":[{"content":"<pre data-lines=\"2335,2404\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">RayTracer</span>\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> Ray\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 origin;\n        <span class=\"hljs-keyword\">public</span> Vector3 direction;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Vector3 <span class=\"hljs-title\">GetPoint</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> t</span>)</span>\n        {\n            <span class=\"hljs-keyword\">return</span> origin + direction * t;\n        }\n    }\n    \n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> RayHit\n    {\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> distance;\n        <span class=\"hljs-keyword\">public</span> Vector3 point;\n        <span class=\"hljs-keyword\">public</span> Vector3 normal;\n        <span class=\"hljs-keyword\">public</span> Material material;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Color <span class=\"hljs-title\">TraceRay</span>(<span class=\"hljs-params\">Ray ray, <span class=\"hljs-built_in\">int</span> depth</span>)</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (depth &lt;= <span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">return</span> Color.black;\n        \n        RayHit hit;\n        <span class=\"hljs-keyword\">if</span> (!Scene.Intersect(ray, <span class=\"hljs-keyword\">out</span> hit))\n            <span class=\"hljs-keyword\">return</span> GetEnvironmentColor(ray);\n            \n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x76f4;&#x63a5;&#x5149;&#x7167;</span>\n        Color directLight = CalculateDirectLighting(hit);\n        \n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x53cd;&#x5c04;</span>\n        Ray reflectedRay = <span class=\"hljs-keyword\">new</span> Ray\n        {\n            origin = hit.point + hit.normal * <span class=\"hljs-number\">0.001f</span>,\n            direction = Vector3.Reflect(ray.direction, hit.normal)\n        };\n        \n        Color reflectedColor = TraceRay(reflectedRay, depth - <span class=\"hljs-number\">1</span>);\n        \n        <span class=\"hljs-keyword\">return</span> directLight + reflectedColor * hit.material.reflectivity;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Color <span class=\"hljs-title\">CalculateDirectLighting</span>(<span class=\"hljs-params\">RayHit hit</span>)</span>\n    {\n        Color totalLight = Color.black;\n        \n        <span class=\"hljs-keyword\">foreach</span> (Light light <span class=\"hljs-keyword\">in</span> Scene.lights)\n        {\n            Vector3 lightDir = (light.position - hit.point).normalized;\n            <span class=\"hljs-built_in\">float</span> diffuse = Mathf.Max(<span class=\"hljs-number\">0</span>, Vector3.Dot(hit.normal, lightDir));\n            \n            <span class=\"hljs-comment\">// &#x68c0;&#x67e5;&#x9634;&#x5f71;</span>\n            Ray shadowRay = <span class=\"hljs-keyword\">new</span> Ray\n            {\n                origin = hit.point + hit.normal * <span class=\"hljs-number\">0.001f</span>,\n                direction = lightDir\n            };\n            \n            <span class=\"hljs-keyword\">if</span> (!Scene.Intersect(shadowRay, <span class=\"hljs-keyword\">out</span> _))\n                totalLight += light.color * diffuse;\n        }\n        \n        <span class=\"hljs-keyword\">return</span> totalLight;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2335,2404"}}],"payload":{"tag":"h3","lines":"2334,2335"}},{"content":"28.2 &#x8def;&#x5f84;&#x8ffd;&#x8e2a;","children":[{"content":"<pre data-lines=\"2406,2459\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">PathTracer</span> : <span class=\"hljs-title\">RayTracer</span>\n{\n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Color <span class=\"hljs-title\">TracePath</span>(<span class=\"hljs-params\">Ray ray, <span class=\"hljs-built_in\">int</span> depth</span>)</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (depth &lt;= <span class=\"hljs-number\">0</span>) <span class=\"hljs-keyword\">return</span> Color.black;\n        \n        RayHit hit;\n        <span class=\"hljs-keyword\">if</span> (!Scene.Intersect(ray, <span class=\"hljs-keyword\">out</span> hit))\n            <span class=\"hljs-keyword\">return</span> GetEnvironmentColor(ray);\n            \n        <span class=\"hljs-comment\">// &#x4fc4;&#x7f57;&#x65af;&#x8f6e;&#x76d8;&#x8d4c;</span>\n        <span class=\"hljs-built_in\">float</span> survivalProbability = <span class=\"hljs-number\">0.8f</span>;\n        <span class=\"hljs-keyword\">if</span> (Random.<span class=\"hljs-keyword\">value</span> &gt; survivalProbability)\n            <span class=\"hljs-keyword\">return</span> Color.black;\n            \n        <span class=\"hljs-comment\">// &#x751f;&#x6210;&#x968f;&#x673a;&#x65b9;&#x5411;</span>\n        Vector3 randomDir = GenerateRandomDirection(hit.normal);\n        Ray bounceRay = <span class=\"hljs-keyword\">new</span> Ray\n        {\n            origin = hit.point + hit.normal * <span class=\"hljs-number\">0.001f</span>,\n            direction = randomDir\n        };\n        \n        Color incomingLight = TracePath(bounceRay, depth - <span class=\"hljs-number\">1</span>);\n        <span class=\"hljs-built_in\">float</span> cosTheta = Vector3.Dot(randomDir, hit.normal);\n        \n        <span class=\"hljs-keyword\">return</span> (hit.material.albedo * incomingLight * cosTheta) / \n               (survivalProbability * Mathf.PI);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Vector3 <span class=\"hljs-title\">GenerateRandomDirection</span>(<span class=\"hljs-params\">Vector3 normal</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x5728;&#x6cd5;&#x7ebf;&#x534a;&#x7403;&#x4e0a;&#x751f;&#x6210;&#x968f;&#x673a;&#x65b9;&#x5411;</span>\n        <span class=\"hljs-built_in\">float</span> u1 = Random.<span class=\"hljs-keyword\">value</span>;\n        <span class=\"hljs-built_in\">float</span> u2 = Random.<span class=\"hljs-keyword\">value</span>;\n        \n        <span class=\"hljs-built_in\">float</span> r = Mathf.Sqrt(u1);\n        <span class=\"hljs-built_in\">float</span> theta = <span class=\"hljs-number\">2</span> * Mathf.PI * u2;\n        \n        <span class=\"hljs-built_in\">float</span> x = r * Mathf.Cos(theta);\n        <span class=\"hljs-built_in\">float</span> y = r * Mathf.Sin(theta);\n        <span class=\"hljs-built_in\">float</span> z = Mathf.Sqrt(<span class=\"hljs-number\">1</span> - u1);\n        \n        <span class=\"hljs-comment\">// &#x5c06;&#x65b9;&#x5411;&#x5bf9;&#x9f50;&#x5230;&#x6cd5;&#x7ebf;&#x7a7a;&#x95f4;</span>\n        Vector3 tangent = Vector3.Cross(normal, \n            Mathf.Abs(normal.x) &gt; <span class=\"hljs-number\">0.9f</span> ? Vector3.up : Vector3.right);\n        Vector3 bitangent = Vector3.Cross(normal, tangent);\n        \n        <span class=\"hljs-keyword\">return</span> (tangent * x + bitangent * y + normal * z).normalized;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2406,2459"}}],"payload":{"tag":"h3","lines":"2405,2406"}}],"payload":{"tag":"h2","lines":"2333,2334"}},{"content":"&#x4e8c;&#x5341;&#x4e5d;. &#x5168;&#x5c40;&#x5149;&#x7167;","children":[{"content":"29.1 &#x5149;&#x7167;&#x63a2;&#x9488;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"2462,2515\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">LightProbeSystem</span>\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> ProbeData\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 position;\n        <span class=\"hljs-keyword\">public</span> SphericalHarmonics3 sh;\n    }\n    \n    <span class=\"hljs-keyword\">private</span> List&lt;ProbeData&gt; probes = <span class=\"hljs-keyword\">new</span> List&lt;ProbeData&gt;();\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">BakeProbes</span>()</span>\n    {\n        <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> probe <span class=\"hljs-keyword\">in</span> probes)\n        {\n            SphericalHarmonics3 sh = <span class=\"hljs-keyword\">new</span> SphericalHarmonics3();\n            \n            <span class=\"hljs-comment\">// &#x5728;&#x7403;&#x9762;&#x4e0a;&#x91c7;&#x6837;</span>\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">64</span>; i++)\n            {\n                Vector3 dir = GetSphericalDirection(i);\n                Color radiance = SampleEnvironment(probe.position, dir);\n                \n                <span class=\"hljs-comment\">// &#x6295;&#x5f71;&#x5230;&#x7403;&#x8c10;&#x51fd;&#x6570;</span>\n                sh.AddDirectionalLight(dir, radiance, <span class=\"hljs-number\">1.0f</span>);\n            }\n            \n            probe.sh = sh;\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Color <span class=\"hljs-title\">SampleProbes</span>(<span class=\"hljs-params\">Vector3 position, Vector3 normal</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x627e;&#x5230;&#x6700;&#x8fd1;&#x7684;&#x63a2;&#x9488;</span>\n        List&lt;ProbeData&gt; nearestProbes = FindNearestProbes(position);\n        \n        <span class=\"hljs-comment\">// &#x4e09;&#x7ebf;&#x6027;&#x63d2;&#x503c;</span>\n        Color result = Color.black;\n        <span class=\"hljs-built_in\">float</span> totalWeight = <span class=\"hljs-number\">0</span>;\n        \n        <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> probe <span class=\"hljs-keyword\">in</span> nearestProbes)\n        {\n            <span class=\"hljs-built_in\">float</span> weight = <span class=\"hljs-number\">1.0f</span> / (position - probe.position).magnitude;\n            totalWeight += weight;\n            \n            Color probeLight = probe.sh.EvaluateLight(normal);\n            result += probeLight * weight;\n        }\n        \n        <span class=\"hljs-keyword\">return</span> result / totalWeight;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2462,2515"}}],"payload":{"tag":"h3","lines":"2461,2462"}}],"payload":{"tag":"h2","lines":"2460,2461"}},{"content":"&#x4e09;&#x5341;. &#x5b9e;&#x65f6;&#x9634;&#x5f71;","children":[{"content":"30.1 &#x7ea7;&#x8054;&#x9634;&#x5f71;&#x8d34;&#x56fe;","children":[{"content":"<pre data-lines=\"2518,2582\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">CascadedShadowMapping</span>\n{\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">struct</span> Cascade\n    {\n        <span class=\"hljs-keyword\">public</span> Matrix4x4 viewProjection;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> splitDistance;\n        <span class=\"hljs-keyword\">public</span> RenderTexture shadowMap;\n    }\n    \n    <span class=\"hljs-keyword\">private</span> Cascade[] cascades;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">UpdateCascades</span>(<span class=\"hljs-params\">Camera camera</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> nearClip = camera.nearClipPlane;\n        <span class=\"hljs-built_in\">float</span> farClip = camera.farClipPlane;\n        <span class=\"hljs-built_in\">int</span> cascadeCount = cascades.Length;\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; cascadeCount; i++)\n        {\n            <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x5206;&#x5272;&#x8ddd;&#x79bb;</span>\n            <span class=\"hljs-built_in\">float</span> splitStart = i == <span class=\"hljs-number\">0</span> ? nearClip : \n                cascades[i<span class=\"hljs-number\">-1</span>].splitDistance;\n            <span class=\"hljs-built_in\">float</span> splitEnd = i == cascadeCount<span class=\"hljs-number\">-1</span> ? farClip :\n                CalculateSplitDistance(nearClip, farClip, i, cascadeCount);\n                \n            cascades[i].splitDistance = splitEnd;\n            \n            <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x5305;&#x56f4;&#x76d2;</span>\n            Bounds bounds = CalculateCascadeBounds(camera, splitStart, splitEnd);\n            \n            <span class=\"hljs-comment\">// &#x8bbe;&#x7f6e;&#x9634;&#x5f71;&#x76f8;&#x673a;</span>\n            Matrix4x4 view = CalculateLightViewMatrix();\n            Matrix4x4 proj = CalculateOrthographicProjection(bounds);\n            cascades[i].viewProjection = proj * view;\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">CalculateSplitDistance</span>(<span class=\"hljs-params\">\n        <span class=\"hljs-built_in\">float</span> near, <span class=\"hljs-built_in\">float</span> far, <span class=\"hljs-built_in\">int</span> cascadeIndex, <span class=\"hljs-built_in\">int</span> cascadeCount</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> lambda = <span class=\"hljs-number\">0.75f</span>;\n        <span class=\"hljs-built_in\">float</span> ratio = cascadeIndex / (<span class=\"hljs-built_in\">float</span>)cascadeCount;\n        \n        <span class=\"hljs-built_in\">float</span> uniformSplit = near + (far - near) * ratio;\n        <span class=\"hljs-built_in\">float</span> logarithmicSplit = near * Mathf.Pow(far/near, ratio);\n        \n        <span class=\"hljs-keyword\">return</span> logarithmicSplit * lambda + uniformSplit * (<span class=\"hljs-number\">1</span> - lambda);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">RenderShadowMaps</span>(<span class=\"hljs-params\">Light light</span>)</span>\n    {\n        <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> cascade <span class=\"hljs-keyword\">in</span> cascades)\n        {\n            <span class=\"hljs-comment\">// &#x8bbe;&#x7f6e;&#x9634;&#x5f71;&#x76f8;&#x673a;</span>\n            Graphics.SetRenderTarget(cascade.shadowMap);\n            GL.Clear(<span class=\"hljs-literal\">true</span>, <span class=\"hljs-literal\">true</span>, Color.white);\n            \n            <span class=\"hljs-comment\">// &#x6e32;&#x67d3;&#x573a;&#x666f;&#x5230;&#x9634;&#x5f71;&#x8d34;&#x56fe;</span>\n            RenderShadowCasters(cascade.viewProjection);\n        }\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2518,2582"}}],"payload":{"tag":"h3","lines":"2517,2518"}}],"payload":{"tag":"h2","lines":"2516,2517"}},{"content":"&#x4e09;&#x5341;&#x4e00;. PBR&#x6e32;&#x67d3;","children":[{"content":"31.1 &#x57fa;&#x4e8e;&#x7269;&#x7406;&#x7684;&#x6750;&#x8d28;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"2585,2661\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">PBRMaterial</span>\n{\n    <span class=\"hljs-keyword\">public</span> Color albedo;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> metallic;\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">float</span> roughness;\n    <span class=\"hljs-keyword\">public</span> Vector3 normal;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Color <span class=\"hljs-title\">CalculateBRDF</span>(<span class=\"hljs-params\">\n        Vector3 lightDir, \n        Vector3 viewDir, \n        Color lightColor</span>)</span>\n    {\n        Vector3 halfVector = (lightDir + viewDir).normalized;\n        \n        <span class=\"hljs-built_in\">float</span> NdotL = Mathf.Max(<span class=\"hljs-number\">0</span>, Vector3.Dot(normal, lightDir));\n        <span class=\"hljs-built_in\">float</span> NdotV = Mathf.Max(<span class=\"hljs-number\">0</span>, Vector3.Dot(normal, viewDir));\n        <span class=\"hljs-built_in\">float</span> NdotH = Mathf.Max(<span class=\"hljs-number\">0</span>, Vector3.Dot(normal, halfVector));\n        <span class=\"hljs-built_in\">float</span> HdotV = Mathf.Max(<span class=\"hljs-number\">0</span>, Vector3.Dot(halfVector, viewDir));\n        \n        <span class=\"hljs-comment\">// &#x83f2;&#x6d85;&#x5c14;&#x9879;</span>\n        Color F0 = Color.Lerp(\n            <span class=\"hljs-keyword\">new</span> Color(<span class=\"hljs-number\">0.04f</span>, <span class=\"hljs-number\">0.04f</span>, <span class=\"hljs-number\">0.04f</span>), \n            albedo, \n            metallic\n        );\n        Color F = FresnelSchlick(HdotV, F0);\n        \n        <span class=\"hljs-comment\">// &#x51e0;&#x4f55;&#x9879;</span>\n        <span class=\"hljs-built_in\">float</span> G = GeometrySmith(NdotV, NdotL);\n        \n        <span class=\"hljs-comment\">// &#x6cd5;&#x7ebf;&#x5206;&#x5e03;</span>\n        <span class=\"hljs-built_in\">float</span> D = DistributionGGX(NdotH);\n        \n        <span class=\"hljs-comment\">// &#x955c;&#x9762;&#x53cd;&#x5c04;&#x9879;</span>\n        Color specular = (F * G * D) / \n            (<span class=\"hljs-number\">4.0f</span> * NdotV * NdotL + <span class=\"hljs-number\">0.001f</span>);\n            \n        <span class=\"hljs-comment\">// &#x6f2b;&#x53cd;&#x5c04;&#x9879;</span>\n        Color kD = (Color.white - F) * (<span class=\"hljs-number\">1</span> - metallic);\n        Color diffuse = kD * albedo / Mathf.PI;\n        \n        <span class=\"hljs-keyword\">return</span> (diffuse + specular) * lightColor * NdotL;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">DistributionGGX</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> NdotH</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> a = roughness * roughness;\n        <span class=\"hljs-built_in\">float</span> a2 = a * a;\n        <span class=\"hljs-built_in\">float</span> NdotH2 = NdotH * NdotH;\n        \n        <span class=\"hljs-built_in\">float</span> nom = a2;\n        <span class=\"hljs-built_in\">float</span> denom = NdotH2 * (a2 - <span class=\"hljs-number\">1.0f</span>) + <span class=\"hljs-number\">1.0f</span>;\n        denom = Mathf.PI * denom * denom;\n        \n        <span class=\"hljs-keyword\">return</span> nom / denom;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> <span class=\"hljs-title\">GeometrySmith</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> NdotV, <span class=\"hljs-built_in\">float</span> NdotL</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span> r = roughness + <span class=\"hljs-number\">1.0f</span>;\n        <span class=\"hljs-built_in\">float</span> k = (r * r) / <span class=\"hljs-number\">8.0f</span>;\n        \n        <span class=\"hljs-built_in\">float</span> ggx1 = NdotV / (NdotV * (<span class=\"hljs-number\">1</span> - k) + k);\n        <span class=\"hljs-built_in\">float</span> ggx2 = NdotL / (NdotL * (<span class=\"hljs-number\">1</span> - k) + k);\n        \n        <span class=\"hljs-keyword\">return</span> ggx1 * ggx2;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Color <span class=\"hljs-title\">FresnelSchlick</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span> cosTheta, Color F0</span>)</span>\n    {\n        <span class=\"hljs-keyword\">return</span> F0 + (Color.white - F0) * \n            Mathf.Pow(<span class=\"hljs-number\">1.0f</span> - cosTheta, <span class=\"hljs-number\">5.0f</span>);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2585,2661"}}],"payload":{"tag":"h3","lines":"2584,2585"}}],"payload":{"tag":"h2","lines":"2583,2584"}},{"content":"&#x4e09;&#x5341;&#x4e8c;. &#x540e;&#x5904;&#x7406;&#x6548;&#x679c;","children":[{"content":"32.1 &#x5c4f;&#x5e55;&#x7a7a;&#x95f4;&#x73af;&#x5883;&#x5149;&#x906e;&#x853d;","children":[{"content":"<pre data-lines=\"2664,2731\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SSAO</span>\n{\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">int</span> SAMPLE_COUNT = <span class=\"hljs-number\">64</span>;\n    <span class=\"hljs-keyword\">private</span> Vector3[] sampleKernel;\n    <span class=\"hljs-keyword\">private</span> Texture2D noiseTexture;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Initialize</span>()</span>\n    {\n        <span class=\"hljs-comment\">// &#x751f;&#x6210;&#x91c7;&#x6837;&#x6838;&#x5fc3;</span>\n        sampleKernel = <span class=\"hljs-keyword\">new</span> Vector3[SAMPLE_COUNT];\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; SAMPLE_COUNT; i++)\n        {\n            Vector3 sample = <span class=\"hljs-keyword\">new</span> Vector3(\n                Random.Range(<span class=\"hljs-number\">-1f</span>, <span class=\"hljs-number\">1f</span>),\n                Random.Range(<span class=\"hljs-number\">-1f</span>, <span class=\"hljs-number\">1f</span>),\n                Random.Range(<span class=\"hljs-number\">0f</span>, <span class=\"hljs-number\">1f</span>)\n            ).normalized;\n            \n            <span class=\"hljs-built_in\">float</span> scale = (<span class=\"hljs-built_in\">float</span>)i / SAMPLE_COUNT;\n            scale = Mathf.Lerp(<span class=\"hljs-number\">0.1f</span>, <span class=\"hljs-number\">1.0f</span>, scale * scale);\n            sampleKernel[i] = sample * scale;\n        }\n        \n        <span class=\"hljs-comment\">// &#x751f;&#x6210;&#x566a;&#x58f0;&#x7eb9;&#x7406;</span>\n        GenerateNoiseTexture();\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Render</span>(<span class=\"hljs-params\">\n        RenderTexture source, \n        RenderTexture destination,\n        Camera camera</span>)</span>\n    {\n        Material ssaoMaterial = <span class=\"hljs-keyword\">new</span> Material(Shader.Find(<span class=\"hljs-string\">&quot;Hidden/SSAO&quot;</span>));\n        \n        ssaoMaterial.SetVectorArray(<span class=\"hljs-string\">&quot;_Samples&quot;</span>, \n            Array.ConvertAll(sampleKernel, v =&gt; (Vector4)v));\n        ssaoMaterial.SetTexture(<span class=\"hljs-string\">&quot;_NoiseTex&quot;</span>, noiseTexture);\n        ssaoMaterial.SetMatrix(<span class=\"hljs-string\">&quot;_ProjectionMatrix&quot;</span>, \n            camera.projectionMatrix);\n        \n        Graphics.Blit(source, destination, ssaoMaterial);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">GenerateNoiseTexture</span>()</span>\n    {\n        <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">int</span> noiseSize = <span class=\"hljs-number\">4</span>;\n        noiseTexture = <span class=\"hljs-keyword\">new</span> Texture2D(noiseSize, noiseSize, \n            TextureFormat.RGB24, <span class=\"hljs-literal\">false</span>);\n        \n        Color[] noiseData = <span class=\"hljs-keyword\">new</span> Color[noiseSize * noiseSize];\n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; noiseSize * noiseSize; i++)\n        {\n            Vector3 noise = <span class=\"hljs-keyword\">new</span> Vector3(\n                Random.Range(<span class=\"hljs-number\">-1f</span>, <span class=\"hljs-number\">1f</span>),\n                Random.Range(<span class=\"hljs-number\">-1f</span>, <span class=\"hljs-number\">1f</span>),\n                <span class=\"hljs-number\">0</span>\n            ).normalized;\n            \n            noiseData[i] = <span class=\"hljs-keyword\">new</span> Color(noise.x, noise.y, noise.z);\n        }\n        \n        noiseTexture.SetPixels(noiseData);\n        noiseTexture.Apply();\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2664,2731"}}],"payload":{"tag":"h3","lines":"2663,2664"}}],"payload":{"tag":"h2","lines":"2662,2663"}},{"content":"&#x4e09;&#x5341;&#x4e09;. &#x7a7a;&#x95f4;&#x641c;&#x7d22;&#x7b97;&#x6cd5;","children":[{"content":"33.1 &#x516b;&#x53c9;&#x6811;&#x7a7a;&#x95f4;&#x641c;&#x7d22;","children":[{"content":"<pre data-lines=\"2734,2797\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OctreeSearch</span>&lt;<span class=\"hljs-title\">T</span>&gt; <span class=\"hljs-keyword\">where</span> <span class=\"hljs-title\">T</span> : <span class=\"hljs-keyword\">class</span>\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OctreeNode</span>\n    {\n        <span class=\"hljs-keyword\">public</span> Bounds bounds;\n        <span class=\"hljs-keyword\">public</span> List&lt;T&gt; objects;\n        <span class=\"hljs-keyword\">public</span> OctreeNode[] children;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">OctreeNode</span>(<span class=\"hljs-params\">Bounds bounds</span>)</span>\n        {\n            <span class=\"hljs-keyword\">this</span>.bounds = bounds;\n            <span class=\"hljs-keyword\">this</span>.objects = <span class=\"hljs-keyword\">new</span> List&lt;T&gt;();\n        }\n    }\n    \n    <span class=\"hljs-keyword\">private</span> OctreeNode root;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">int</span> maxDepth;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">int</span> maxObjectsPerNode;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> List&lt;T&gt; <span class=\"hljs-title\">SphereQuery</span>(<span class=\"hljs-params\">Vector3 center, <span class=\"hljs-built_in\">float</span> radius</span>)</span>\n    {\n        List&lt;T&gt; result = <span class=\"hljs-keyword\">new</span> List&lt;T&gt;();\n        SphereQuery(root, center, radius, result);\n        <span class=\"hljs-keyword\">return</span> result;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">SphereQuery</span>(<span class=\"hljs-params\">\n        OctreeNode node, \n        Vector3 center, \n        <span class=\"hljs-built_in\">float</span> radius, \n        List&lt;T&gt; result</span>)</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (node == <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span>;\n        \n        <span class=\"hljs-comment\">// &#x68c0;&#x67e5;&#x8282;&#x70b9;&#x8fb9;&#x754c;&#x662f;&#x5426;&#x4e0e;&#x7403;&#x4f53;&#x76f8;&#x4ea4;</span>\n        <span class=\"hljs-keyword\">if</span> (!IntersectsSphere(node.bounds, center, radius))\n            <span class=\"hljs-keyword\">return</span>;\n            \n        <span class=\"hljs-comment\">// &#x6dfb;&#x52a0;&#x5f53;&#x524d;&#x8282;&#x70b9;&#x4e2d;&#x7684;&#x5bf9;&#x8c61;</span>\n        <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> obj <span class=\"hljs-keyword\">in</span> node.objects)\n        {\n            Vector3 objPos = GetObjectPosition(obj);\n            <span class=\"hljs-keyword\">if</span> (Vector3.Distance(center, objPos) &lt;= radius)\n                result.Add(obj);\n        }\n        \n        <span class=\"hljs-comment\">// &#x9012;&#x5f52;&#x68c0;&#x67e5;&#x5b50;&#x8282;&#x70b9;</span>\n        <span class=\"hljs-keyword\">if</span> (node.children != <span class=\"hljs-literal\">null</span>)\n        {\n            <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> child <span class=\"hljs-keyword\">in</span> node.children)\n                SphereQuery(child, center, radius, result);\n        }\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">bool</span> <span class=\"hljs-title\">IntersectsSphere</span>(<span class=\"hljs-params\">Bounds bounds, Vector3 center, <span class=\"hljs-built_in\">float</span> radius</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x5305;&#x56f4;&#x76d2;&#x5230;&#x7403;&#x5fc3;&#x7684;&#x6700;&#x8fd1;&#x70b9;</span>\n        Vector3 closest = bounds.ClosestPoint(center);\n        <span class=\"hljs-keyword\">return</span> Vector3.Distance(closest, center) &lt;= radius;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2734,2797"}}],"payload":{"tag":"h3","lines":"2733,2734"}},{"content":"33.2 KD&#x6811;&#x641c;&#x7d22;","children":[{"content":"<pre data-lines=\"2799,2879\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">KDTree</span>&lt;<span class=\"hljs-title\">T</span>&gt;\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">KDNode</span>\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 position;\n        <span class=\"hljs-keyword\">public</span> T data;\n        <span class=\"hljs-keyword\">public</span> KDNode left;\n        <span class=\"hljs-keyword\">public</span> KDNode right;\n        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">int</span> splitAxis;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">KDNode</span>(<span class=\"hljs-params\">Vector3 position, T data, <span class=\"hljs-built_in\">int</span> splitAxis</span>)</span>\n        {\n            <span class=\"hljs-keyword\">this</span>.position = position;\n            <span class=\"hljs-keyword\">this</span>.data = data;\n            <span class=\"hljs-keyword\">this</span>.splitAxis = splitAxis;\n        }\n    }\n    \n    <span class=\"hljs-keyword\">private</span> KDNode root;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Insert</span>(<span class=\"hljs-params\">Vector3 position, T data</span>)</span>\n    {\n        root = Insert(root, position, data, <span class=\"hljs-number\">0</span>);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> KDNode <span class=\"hljs-title\">Insert</span>(<span class=\"hljs-params\">\n        KDNode node, \n        Vector3 position, \n        T data, \n        <span class=\"hljs-built_in\">int</span> depth</span>)</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (node == <span class=\"hljs-literal\">null</span>)\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> KDNode(position, data, depth % <span class=\"hljs-number\">3</span>);\n            \n        <span class=\"hljs-built_in\">int</span> axis = depth % <span class=\"hljs-number\">3</span>;\n        <span class=\"hljs-built_in\">float</span> compare = position[axis] - node.position[axis];\n        \n        <span class=\"hljs-keyword\">if</span> (compare &lt; <span class=\"hljs-number\">0</span>)\n            node.left = Insert(node.left, position, data, depth + <span class=\"hljs-number\">1</span>);\n        <span class=\"hljs-keyword\">else</span>\n            node.right = Insert(node.right, position, data, depth + <span class=\"hljs-number\">1</span>);\n            \n        <span class=\"hljs-keyword\">return</span> node;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> List&lt;T&gt; <span class=\"hljs-title\">FindNearest</span>(<span class=\"hljs-params\">Vector3 position, <span class=\"hljs-built_in\">float</span> maxDistance</span>)</span>\n    {\n        List&lt;T&gt; result = <span class=\"hljs-keyword\">new</span> List&lt;T&gt;();\n        FindNearest(root, position, maxDistance, result);\n        <span class=\"hljs-keyword\">return</span> result;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">FindNearest</span>(<span class=\"hljs-params\">\n        KDNode node, \n        Vector3 position, \n        <span class=\"hljs-built_in\">float</span> maxDistance, \n        List&lt;T&gt; result</span>)</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (node == <span class=\"hljs-literal\">null</span>) <span class=\"hljs-keyword\">return</span>;\n        \n        <span class=\"hljs-built_in\">float</span> distance = Vector3.Distance(position, node.position);\n        <span class=\"hljs-keyword\">if</span> (distance &lt;= maxDistance)\n            result.Add(node.data);\n            \n        <span class=\"hljs-built_in\">int</span> axis = node.splitAxis;\n        <span class=\"hljs-built_in\">float</span> delta = position[axis] - node.position[axis];\n        \n        <span class=\"hljs-comment\">// &#x9012;&#x5f52;&#x641c;&#x7d22;&#x6700;&#x53ef;&#x80fd;&#x5305;&#x542b;&#x8fd1;&#x90bb;&#x7684;&#x5b50;&#x6811;</span>\n        KDNode first = delta &lt; <span class=\"hljs-number\">0</span> ? node.left : node.right;\n        KDNode second = delta &lt; <span class=\"hljs-number\">0</span> ? node.right : node.left;\n        \n        FindNearest(first, position, maxDistance, result);\n        \n        <span class=\"hljs-comment\">// &#x5982;&#x679c;&#x53ef;&#x80fd;&#x5728;&#x53e6;&#x4e00;&#x4fa7;&#x627e;&#x5230;&#x66f4;&#x8fd1;&#x7684;&#x70b9;&#xff0c;&#x4e5f;&#x641c;&#x7d22;&#x53e6;&#x4e00;&#x4fa7;</span>\n        <span class=\"hljs-keyword\">if</span> (Mathf.Abs(delta) &lt;= maxDistance)\n            FindNearest(second, position, maxDistance, result);\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2799,2879"}}],"payload":{"tag":"h3","lines":"2798,2799"}}],"payload":{"tag":"h2","lines":"2732,2733"}},{"content":"&#x4e09;&#x5341;&#x56db;. &#x667a;&#x80fd;&#x5bfb;&#x8def;&#x7cfb;&#x7edf;","children":[{"content":"34.1 &#x5bfc;&#x822a;&#x7f51;&#x683c;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"2882,3009\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">NavigationMesh</span>\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Triangle</span>\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3[] vertices;\n        <span class=\"hljs-keyword\">public</span> List&lt;Triangle&gt; neighbors;\n        <span class=\"hljs-keyword\">public</span> Vector3 center;\n        <span class=\"hljs-keyword\">public</span> Vector3 normal;\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">Triangle</span>(<span class=\"hljs-params\">Vector3[] vertices</span>)</span>\n        {\n            <span class=\"hljs-keyword\">this</span>.vertices = vertices;\n            <span class=\"hljs-keyword\">this</span>.neighbors = <span class=\"hljs-keyword\">new</span> List&lt;Triangle&gt;();\n            CalculateProperties();\n        }\n        \n        <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">CalculateProperties</span>()</span>\n        {\n            <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x4e2d;&#x5fc3;&#x70b9;</span>\n            center = (vertices[<span class=\"hljs-number\">0</span>] + vertices[<span class=\"hljs-number\">1</span>] + vertices[<span class=\"hljs-number\">2</span>]) / <span class=\"hljs-number\">3f</span>;\n            \n            <span class=\"hljs-comment\">// &#x8ba1;&#x7b97;&#x6cd5;&#x7ebf;</span>\n            Vector3 edge1 = vertices[<span class=\"hljs-number\">1</span>] - vertices[<span class=\"hljs-number\">0</span>];\n            Vector3 edge2 = vertices[<span class=\"hljs-number\">2</span>] - vertices[<span class=\"hljs-number\">0</span>];\n            normal = Vector3.Cross(edge1, edge2).normalized;\n        }\n    }\n    \n    <span class=\"hljs-keyword\">private</span> List&lt;Triangle&gt; triangles;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> List&lt;Vector3&gt; <span class=\"hljs-title\">FindPath</span>(<span class=\"hljs-params\">Vector3 start, Vector3 end</span>)</span>\n    {\n        Triangle startTri = FindContainingTriangle(start);\n        Triangle endTri = FindContainingTriangle(end);\n        \n        <span class=\"hljs-keyword\">if</span> (startTri == <span class=\"hljs-literal\">null</span> || endTri == <span class=\"hljs-literal\">null</span>)\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">null</span>;\n            \n        <span class=\"hljs-comment\">// A*&#x5bfb;&#x8def;</span>\n        List&lt;Triangle&gt; path = AStarSearch(startTri, endTri);\n        \n        <span class=\"hljs-comment\">// &#x8def;&#x5f84;&#x5e73;&#x6ed1;&#x5316;</span>\n        <span class=\"hljs-keyword\">return</span> SmoothPath(path, start, end);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> List&lt;Triangle&gt; <span class=\"hljs-title\">AStarSearch</span>(<span class=\"hljs-params\">Triangle start, Triangle end</span>)</span>\n    {\n        <span class=\"hljs-keyword\">var</span> openSet = <span class=\"hljs-keyword\">new</span> PriorityQueue&lt;Triangle&gt;();\n        <span class=\"hljs-keyword\">var</span> closedSet = <span class=\"hljs-keyword\">new</span> HashSet&lt;Triangle&gt;();\n        <span class=\"hljs-keyword\">var</span> cameFrom = <span class=\"hljs-keyword\">new</span> Dictionary&lt;Triangle, Triangle&gt;();\n        <span class=\"hljs-keyword\">var</span> gScore = <span class=\"hljs-keyword\">new</span> Dictionary&lt;Triangle, <span class=\"hljs-built_in\">float</span>&gt;();\n        <span class=\"hljs-keyword\">var</span> fScore = <span class=\"hljs-keyword\">new</span> Dictionary&lt;Triangle, <span class=\"hljs-built_in\">float</span>&gt;();\n        \n        openSet.Enqueue(start, <span class=\"hljs-number\">0</span>);\n        gScore[start] = <span class=\"hljs-number\">0</span>;\n        fScore[start] = Vector3.Distance(start.center, end.center);\n        \n        <span class=\"hljs-keyword\">while</span> (openSet.Count &gt; <span class=\"hljs-number\">0</span>)\n        {\n            Triangle current = openSet.Dequeue();\n            \n            <span class=\"hljs-keyword\">if</span> (current == end)\n                <span class=\"hljs-keyword\">return</span> ReconstructPath(cameFrom, end);\n                \n            closedSet.Add(current);\n            \n            <span class=\"hljs-keyword\">foreach</span> (<span class=\"hljs-keyword\">var</span> neighbor <span class=\"hljs-keyword\">in</span> current.neighbors)\n            {\n                <span class=\"hljs-keyword\">if</span> (closedSet.Contains(neighbor))\n                    <span class=\"hljs-keyword\">continue</span>;\n                    \n                <span class=\"hljs-built_in\">float</span> tentativeGScore = gScore[current] + \n                    Vector3.Distance(current.center, neighbor.center);\n                    \n                <span class=\"hljs-keyword\">if</span> (!gScore.ContainsKey(neighbor) || \n                    tentativeGScore &lt; gScore[neighbor])\n                {\n                    cameFrom[neighbor] = current;\n                    gScore[neighbor] = tentativeGScore;\n                    fScore[neighbor] = gScore[neighbor] + \n                        Vector3.Distance(neighbor.center, end.center);\n                        \n                    <span class=\"hljs-keyword\">if</span> (!openSet.Contains(neighbor))\n                        openSet.Enqueue(neighbor, fScore[neighbor]);\n                }\n            }\n        }\n        \n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">null</span>;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> List&lt;Vector3&gt; <span class=\"hljs-title\">SmoothPath</span>(<span class=\"hljs-params\">\n        List&lt;Triangle&gt; trianglePath, \n        Vector3 start, \n        Vector3 end</span>)</span>\n    {\n        List&lt;Vector3&gt; path = <span class=\"hljs-keyword\">new</span> List&lt;Vector3&gt; { start };\n        Vector3 current = start;\n        <span class=\"hljs-built_in\">int</span> lookAhead = <span class=\"hljs-number\">2</span>;\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; trianglePath.Count; i++)\n        {\n            <span class=\"hljs-comment\">// &#x5c1d;&#x8bd5;&#x76f4;&#x63a5;&#x8fde;&#x63a5;&#x5230;&#x66f4;&#x8fdc;&#x7684;&#x70b9;</span>\n            <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> j = Mathf.Min(i + lookAhead, trianglePath.Count - <span class=\"hljs-number\">1</span>); \n                 j &gt; i; j--)\n            {\n                Vector3 target = j == trianglePath.Count - <span class=\"hljs-number\">1</span> ? \n                    end : trianglePath[j].center;\n                    \n                <span class=\"hljs-keyword\">if</span> (CanWalkDirectly(current, target, trianglePath))\n                {\n                    path.Add(target);\n                    current = target;\n                    i = j;\n                    <span class=\"hljs-keyword\">break</span>;\n                }\n            }\n        }\n        \n        <span class=\"hljs-keyword\">if</span> (path[path.Count - <span class=\"hljs-number\">1</span>] != end)\n            path.Add(end);\n            \n        <span class=\"hljs-keyword\">return</span> path;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"2882,3009"}}],"payload":{"tag":"h3","lines":"2881,2882"}}],"payload":{"tag":"h2","lines":"2880,2881"}},{"content":"&#x4e09;&#x5341;&#x4e94;. &#x884c;&#x4e3a;&#x51b3;&#x7b56;&#x7cfb;&#x7edf;","children":[{"content":"35.1 &#x884c;&#x4e3a;&#x6811;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"3012,3087\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">abstract</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">BehaviorNode</span>\n{\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">enum</span> Status\n    {\n        Success,\n        Failure,\n        Running\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">abstract</span> Status <span class=\"hljs-title\">Execute</span>()</span>;\n}\n\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Sequence</span> : <span class=\"hljs-title\">BehaviorNode</span>\n{\n    <span class=\"hljs-keyword\">private</span> List&lt;BehaviorNode&gt; children = <span class=\"hljs-keyword\">new</span> List&lt;BehaviorNode&gt;();\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">int</span> currentChild = <span class=\"hljs-number\">0</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">override</span> Status <span class=\"hljs-title\">Execute</span>()</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (currentChild &gt;= children.Count)\n            <span class=\"hljs-keyword\">return</span> Status.Success;\n            \n        Status childStatus = children[currentChild].Execute();\n        \n        <span class=\"hljs-keyword\">switch</span> (childStatus)\n        {\n            <span class=\"hljs-keyword\">case</span> Status.Running:\n                <span class=\"hljs-keyword\">return</span> Status.Running;\n                \n            <span class=\"hljs-keyword\">case</span> Status.Success:\n                currentChild++;\n                <span class=\"hljs-keyword\">return</span> currentChild &gt;= children.Count ? \n                    Status.Success : Status.Running;\n                    \n            <span class=\"hljs-keyword\">case</span> Status.Failure:\n                <span class=\"hljs-keyword\">return</span> Status.Failure;\n                \n            <span class=\"hljs-literal\">default</span>:\n                <span class=\"hljs-keyword\">return</span> Status.Success;\n        }\n    }\n}\n\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Selector</span> : <span class=\"hljs-title\">BehaviorNode</span>\n{\n    <span class=\"hljs-keyword\">private</span> List&lt;BehaviorNode&gt; children = <span class=\"hljs-keyword\">new</span> List&lt;BehaviorNode&gt;();\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">int</span> currentChild = <span class=\"hljs-number\">0</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">override</span> Status <span class=\"hljs-title\">Execute</span>()</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (currentChild &gt;= children.Count)\n            <span class=\"hljs-keyword\">return</span> Status.Failure;\n            \n        Status childStatus = children[currentChild].Execute();\n        \n        <span class=\"hljs-keyword\">switch</span> (childStatus)\n        {\n            <span class=\"hljs-keyword\">case</span> Status.Running:\n                <span class=\"hljs-keyword\">return</span> Status.Running;\n                \n            <span class=\"hljs-keyword\">case</span> Status.Success:\n                <span class=\"hljs-keyword\">return</span> Status.Success;\n                \n            <span class=\"hljs-keyword\">case</span> Status.Failure:\n                currentChild++;\n                <span class=\"hljs-keyword\">return</span> currentChild &gt;= children.Count ? \n                    Status.Failure : Status.Running;\n                    \n            <span class=\"hljs-literal\">default</span>:\n                <span class=\"hljs-keyword\">return</span> Status.Failure;\n        }\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"3012,3087"}}],"payload":{"tag":"h3","lines":"3011,3012"}}],"payload":{"tag":"h2","lines":"3010,3011"}},{"content":"&#x4e09;&#x5341;&#x516d;. &#x673a;&#x5668;&#x5b66;&#x4e60;&#x5e94;&#x7528;","children":[{"content":"36.1 &#x5f3a;&#x5316;&#x5b66;&#x4e60;&#x7cfb;&#x7edf;","children":[{"content":"<pre data-lines=\"3090,3136\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">QLearning</span>\n{\n    <span class=\"hljs-keyword\">private</span> Dictionary&lt;<span class=\"hljs-built_in\">string</span>, Dictionary&lt;<span class=\"hljs-built_in\">string</span>, <span class=\"hljs-built_in\">float</span>&gt;&gt; QTable;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> learningRate = <span class=\"hljs-number\">0.1f</span>;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span> discountFactor = <span class=\"hljs-number\">0.9f</span>;\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-built_in\">string</span> <span class=\"hljs-title\">GetBestAction</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">string</span> state</span>)</span>\n    {\n        <span class=\"hljs-keyword\">if</span> (!QTable.ContainsKey(state))\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">null</span>;\n            \n        <span class=\"hljs-keyword\">var</span> actions = QTable[state];\n        <span class=\"hljs-keyword\">return</span> actions.OrderByDescending(x =&gt; x.Value)\n            .First().Key;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">Learn</span>(<span class=\"hljs-params\">\n        <span class=\"hljs-built_in\">string</span> state, \n        <span class=\"hljs-built_in\">string</span> action, \n        <span class=\"hljs-built_in\">float</span> reward, \n        <span class=\"hljs-built_in\">string</span> nextState</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x786e;&#x4fdd;&#x72b6;&#x6001;&#x5b58;&#x5728;&#x4e8e;Q&#x8868;&#x4e2d;</span>\n        <span class=\"hljs-keyword\">if</span> (!QTable.ContainsKey(state))\n            QTable[state] = <span class=\"hljs-keyword\">new</span> Dictionary&lt;<span class=\"hljs-built_in\">string</span>, <span class=\"hljs-built_in\">float</span>&gt;();\n            \n        <span class=\"hljs-keyword\">if</span> (!QTable.ContainsKey(nextState))\n            QTable[nextState] = <span class=\"hljs-keyword\">new</span> Dictionary&lt;<span class=\"hljs-built_in\">string</span>, <span class=\"hljs-built_in\">float</span>&gt;();\n            \n        <span class=\"hljs-comment\">// &#x83b7;&#x53d6;&#x5f53;&#x524d;Q&#x503c;</span>\n        <span class=\"hljs-built_in\">float</span> currentQ = QTable[state].ContainsKey(action) ? \n            QTable[state][action] : <span class=\"hljs-number\">0</span>;\n            \n        <span class=\"hljs-comment\">// &#x83b7;&#x53d6;&#x4e0b;&#x4e00;&#x72b6;&#x6001;&#x7684;&#x6700;&#x5927;Q&#x503c;</span>\n        <span class=\"hljs-built_in\">float</span> maxNextQ = QTable[nextState].Count &gt; <span class=\"hljs-number\">0</span> ? \n            QTable[nextState].Values.Max() : <span class=\"hljs-number\">0</span>;\n            \n        <span class=\"hljs-comment\">// &#x66f4;&#x65b0;Q&#x503c;</span>\n        <span class=\"hljs-built_in\">float</span> newQ = currentQ + learningRate * \n            (reward + discountFactor * maxNextQ - currentQ);\n            \n        QTable[state][action] = newQ;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"3090,3136"}}],"payload":{"tag":"h3","lines":"3089,3090"}}],"payload":{"tag":"h2","lines":"3088,3089"}},{"content":"&#x4e09;&#x5341;&#x4e03;. &#x795e;&#x7ecf;&#x7f51;&#x7edc;&#x5728;3D&#x4e2d;&#x7684;&#x5e94;&#x7528;","children":[{"content":"37.1 3D&#x59ff;&#x6001;&#x4f30;&#x8ba1;","children":[{"content":"<pre data-lines=\"3139,3203\"><code class=\"language-csharp\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">PoseEstimator</span>\n{\n    <span class=\"hljs-keyword\">private</span> NeuralNetwork network;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">int</span> INPUT_SIZE = <span class=\"hljs-number\">1024</span>; <span class=\"hljs-comment\">// 32x32 &#x6df1;&#x5ea6;&#x56fe;</span>\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">const</span> <span class=\"hljs-built_in\">int</span> OUTPUT_SIZE = <span class=\"hljs-number\">7</span>;   <span class=\"hljs-comment\">// &#x4f4d;&#x7f6e;(3) + &#x56db;&#x5143;&#x6570;(4)</span>\n    \n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">struct</span> Pose\n    {\n        <span class=\"hljs-keyword\">public</span> Vector3 position;\n        <span class=\"hljs-keyword\">public</span> Quaternion rotation;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Pose <span class=\"hljs-title\">EstimatePose</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span>[] depthMap</span>)</span>\n    {\n        <span class=\"hljs-comment\">// &#x9884;&#x5904;&#x7406;&#x6df1;&#x5ea6;&#x56fe;</span>\n        <span class=\"hljs-built_in\">float</span>[] processedInput = PreprocessDepthMap(depthMap);\n        \n        <span class=\"hljs-comment\">// &#x8fd0;&#x884c;&#x795e;&#x7ecf;&#x7f51;&#x7edc;</span>\n        <span class=\"hljs-built_in\">float</span>[] output = network.Forward(processedInput);\n        \n        <span class=\"hljs-comment\">// &#x89e3;&#x6790;&#x8f93;&#x51fa;</span>\n        <span class=\"hljs-keyword\">return</span> ParseOutput(output);\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-built_in\">float</span>[] <span class=\"hljs-title\">PreprocessDepthMap</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span>[] depthMap</span>)</span>\n    {\n        <span class=\"hljs-built_in\">float</span>[] processed = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-built_in\">float</span>[INPUT_SIZE];\n        \n        <span class=\"hljs-comment\">// &#x5f52;&#x4e00;&#x5316;</span>\n        <span class=\"hljs-built_in\">float</span> min = depthMap.Min();\n        <span class=\"hljs-built_in\">float</span> max = depthMap.Max();\n        \n        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-built_in\">int</span> i = <span class=\"hljs-number\">0</span>; i &lt; depthMap.Length; i++)\n        {\n            processed[i] = (depthMap[i] - min) / (max - min);\n        }\n        \n        <span class=\"hljs-keyword\">return</span> processed;\n    }\n    \n    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Pose <span class=\"hljs-title\">ParseOutput</span>(<span class=\"hljs-params\"><span class=\"hljs-built_in\">float</span>[] output</span>)</span>\n    {\n        Pose pose = <span class=\"hljs-keyword\">new</span> Pose();\n        \n        <span class=\"hljs-comment\">// &#x89e3;&#x6790;&#x4f4d;&#x7f6e;</span>\n        pose.position = <span class=\"hljs-keyword\">new</span> Vector3(\n            output[<span class=\"hljs-number\">0</span>],\n            output[<span class=\"hljs-number\">1</span>],\n            output[<span class=\"hljs-number\">2</span>]\n        );\n        \n        <span class=\"hljs-comment\">// &#x89e3;&#x6790;&#x65cb;&#x8f6c;&#xff08;&#x56db;&#x5143;&#x6570;&#xff09;</span>\n        pose.rotation = <span class=\"hljs-keyword\">new</span> Quaternion(\n            output[<span class=\"hljs-number\">3</span>],\n            output[<span class=\"hljs-number\">4</span>],\n            output[<span class=\"hljs-number\">5</span>],\n            output[<span class=\"hljs-number\">6</span>]\n        ).normalized;\n        \n        <span class=\"hljs-keyword\">return</span> pose;\n    }\n}\n</code></pre>","children":[],"payload":{"tag":"pre","lines":"3139,3203"}}],"payload":{"tag":"h3","lines":"3138,3139"}}],"payload":{"tag":"h2","lines":"3137,3138"}}]},{})</script>
</body>
</html>

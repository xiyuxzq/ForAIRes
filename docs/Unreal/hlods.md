# HLODs (Hierarchical Level Of Detail) 系统

## 定义

Hierarchical Level Of Detail (HLODs) 是一组Actor的视觉表示，旨在从相当远的距离替换这些Actor。它通常是一个单一的网格和材质，从原始Actor的几何体构建而成，但经过简化以减少内存使用。用 HLOD 替换多个Actor通常会将绘制调用从 N 减少到 1，从而提高性能。

World Partition HLODs 与传统的 UE 4.x HLODs 不同，因为它们不与关卡链接。它们是从 World Partition 网格生成的，无需管理Actor集群。

## UE 5.4 重要更新

### 编辑器中的 HLODs
- 在编辑器视口中显示分层 LOD，无需预先加载区域
- 适用于合并和简化层
- 可以通过选择、右键单击、从选择加载区域来轻松加载重叠 HLODs 的区域
- 用户设置可以切换、在加载区域上方显示并设置最小和最大绘制距离

### 使用 Runtime Hash 时在每个分区对象中定义的 HLODs 设置
- 新的 Runtime Hash 为每个分区对象提供可配置的 HLOD 设置数组
- 使开发者更容易创建自己的分区同时保持 HLOD 支持

### 地形的多个 HLOD 设置
- 更好地控制 HLOD 网格复杂度和纹理大小
- 可以控制计算地形 HLODs 时使用的 LOD 级别
- 项目选项中提供地形 HLODs 纹理的全局最大纹理大小（默认为 1024）

## 最佳实践

1. **预定义 HLOD 层类型、流送和层次结构**
   - 在世界概念和预制作期间定义 HLODs 流送、层次结构和类型
   - 考虑因素：平台内存和性能、实例化、nanite 流送、世界密度等

2. **从运行时/游戏玩法距离查看**
   - HLODs 在使用合并或简化网格类型时近距离可能很丑
   - 它们是为远距离观看而构建的
   - Nanite 启用的实例化层提供与加载资产无法区分的结果

3. **频繁更新**
   - HLODs 在大多数工作流程中不重要，但在进行艺术构图或游戏测试时过时可能会非常有问题
   - HLOD 生成应该经常发生

## 陷阱

1. **将所有Actor保留在 HLODs 中**
   - 使用 HLODs 的首要目标仍然是减少Actor数量并提高性能，同时保持距离质量
   - 小Actor、内部、地下和所有不重要的资产不应添加到 HLODs 中

2. **电影和远景放大镜头**
   - 长焦距镜头可能导致从近距离查看简化的 HLODs 时出现非常糟糕的视觉效果
   - Nanite 启用的实例化层应该有助于缓解一些这些问题

## 限制

1. **生成大型简化和合并的 HLODs**
   - 生成实例化 HLODs 相当快
   - 生成简化或合并网格 HLODs 可能非常耗时和内存密集

2. **地形 HLODs**
   - 地形代理的 HLODs 特定于此系统
   - 目前无法使用为其他Actor设置的相同 HLODs 设置

3. **尚无自定义 HLOD 支持**
   - 系统目前不允许指定自定义构建的 HLODs

## 实际应用案例

### Fortnite Chapter 5
- 建筑物的 HLODs（2 层）
  - HLOD0：支持破坏的特殊合并网格
  - HLOD1：简化网格
- 树木的 HLODs（1 层，非空间加载）
  - 树木替身的实例化层，始终加载
- 持久世界中的 HLODs
  - 悬崖、特殊合并网格案例和大型雕像

### The Matrix Awaken 演示
- 具有 2 层的 HLODs 设置
  - HLOD0：Nanite 启用的实例化层
  - HLOD1：简化网格
- 简化网格处理需要 10 台机器，最坏情况下需要 5 小时
- 实例化层在单台机器上处理不到 10 分钟

## 未来发展

1. Actor和关卡实例的自定义 HLODs 支持
2. 简化和全局 HLODs 生成性能改进（在 5.5 中完成）
3. 完全卸载时子世界分区的 HLOD 支持

## 实用命令

- 运行 `wp.Editor.HLOD.DumpStats` 将生成一个 CSV 文件，包含每个 HLOD 的信息，如纹理大小、三角形和顶点数量以及磁盘大小
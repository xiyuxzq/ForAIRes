# World Partition 系统

## 定义

World Partition 是一个自动数据管理和基于距离的关卡流送系统，为大型世界管理提供完整解决方案。该系统通过将世界存储在单个持久关卡中并将其分为网格单元，消除了之前将大型关卡划分为子关卡的需求，并提供了基于与流送源的距离自动加载和卸载这些单元的系统。

## UE 5.4 重要更新

### Runtime Hash 与 3D 网格

新的 World Partition Runtime Hash 解决方案改进了之前 Spatial Hash 的限制：

- 使用可以是不同类型的分区对象列表
- 允许开发者轻松实现自己的分区方案
- 每个对象持有其 HLODSetups 层设置
- 支持 3D 分区和从提供的 Loose Hierarchical Grid 分区类型进行流送
- 通过可变单元格大小方法减少了轴和网格原点周围的流送级别提升问题
- 保留了对 OFPA、Data Layers、Level Instances、Streaming Sources 和 HLODs 的完整支持
- 在 Fortnite BR 中测量的性能和内存与之前的 Spatial Hash 相似或更好

### 动态子世界分区

提供了在世界中拥有多个子世界分区的可能性：

- 可以通过代码或蓝图启用
- 可以动态选择或从持久或父世界流送
- 支持多层子世界分区关卡

### 专用服务器流送

支持基于流送源位置复制的专用服务器流送，具有额外参数来控制服务器特定的流送。

## 最佳实践

1. **网格设置**
   - 从单个网格开始世界制作
   - 基于游戏玩法、物理和演员数量估算设置"网格大小"和"加载范围"
   - 考虑 Nanite、纹理和音频流送

2. **使用流送源组件**
   - 默认情况下玩家控制器是流送源
   - 可以添加流送源组件到任何演员
   - 可以调整流送源形状、优先级、目标网格和目标状态

3. **空间利用**
   - 在概念/预制作阶段，根据目标加载范围布局重要/独特内容
   - 明智地使用空间，创造性地利用它

## 常见陷阱

1. **通过多个网格堆叠导致的关卡乘法**
   - 每个网格的每个单元格（至少包含一个演员）都会产生一个流送关卡
   - 需要考虑堆叠多个网格和活动运行时数据层对性能的影响

2. **演员边界问题**
   - 大型演员边界可能导致内容被提升到持久层
   - 应该限制硬引用/父子关系到附近、重叠或在单元格大小范围内的演员

## 限制

1. **重新配置网格与分区演员**
   - 分区演员（如地形和植被）在重新配置世界的流送网格时不会更新
   - 需要使用命令行工具重新创建分区演员

2. **编辑器中的手动加载**
   - 目前不支持编辑器中基于摄像机的自动加载
   - 内容必须使用世界分区编辑器通过临时区域选择和/或位置体积演员加载

## 实际应用案例

### Fortnite Chapter 5
- 地图大小：2km x 2km
- 演员数量：约 10 万
- 使用单个网格：128m 单元格大小，256m 加载范围
- 使用多层 HLODs 设置
- 支持所有平台从移动到 Switch 到当前世代支持 nanite 的平台

### The Matrix Awaken 演示
- 地图大小：4km x 4km
- 演员数量：约 10.7 万
- 使用单个网格：128m 单元格大小，128m 加载范围
- 使用 Houdini 和 Rule Processor 插件程序化构建

## 未来发展

1. 用于游戏功能插件和 DLC 内容的外部数据层
2. 用于 PIE 和烘焙构建的流送单元转换器框架
3. 运行时关卡注入支持（5.5 版本实验性功能）
4. 地形构建器
5. 改进调试、监控和分析功能
6. 基本支持静态和体积光照图
7. 持续改进用户体验

## 实用命令

- `wp.Runtime.ToggleDrawRuntimeHash2D` 或 `3D`：切换流送网格调试显示
- `wp.Runtime.OverrideRuntimeLoadingRange -grid=[index] -range=[DesiredValue]`：覆盖加载范围
- `wp.runtime.hlod`：切换 HLODs 显示
- `wp.Runtime.DebugDedicatedServerStreaming`：调试专用服务器流送